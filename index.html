<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOUR.NADY | Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-gold: #FFD700;
            --secondary-purple: #8A2BE2;
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 215, 0, 0.3);
            --text-color: #ffffff;
        }

        body.light-mode {
            --bg-dark: #f0f0f0;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(138, 43, 226, 0.3);
            --text-color: #1a1a1a;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-color);
            transition: all 0.3s ease;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(138, 43, 226, 0.15) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 20%);
            background-attachment: fixed;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .neon-border-gold {
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3), inset 0 0 5px rgba(255, 215, 0, 0.1);
            border: 1px solid var(--primary-gold);
        }

        .neon-border-purple {
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);
            border: 1px solid var(--secondary-purple);
        }

        .neon-text-gold {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            color: var(--primary-gold);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .btn-hover {
            transition: all 0.3s ease;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.6);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-gold);
            border-radius: 4px;
        }
        
        .loader {
            border-top-color: var(--primary-gold);
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .markdown-body p { margin-bottom: 0.5rem; }
        .markdown-body ul { list-style-type: disc; margin-right: 1.5rem; }
        .markdown-body ol { list-style-type: decimal; margin-right: 1.5rem; }

        /* Notification Styles */
        #notificationDot {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: red;
            border-radius: 50%;
            border: 1px solid white;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-3 flex justify-between items-center neon-border-purple border-b-2 border-b-[#8A2BE2] border-0 rounded-none">
        <div class="flex items-center gap-3">
          <h1 class="text-2xl font-bold neon-text-gold tracking-widest">♡[NO+SH]</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative">
                <button id="notiToggle" class="p-2 rounded-full hover:bg-white/10 transition text-[#FFD700]">
                    <i class="fas fa-bell"></i>
                    <span id="notificationDot"></span>
                </button>
                <div id="notiMenu" class="hidden absolute left-0 mt-2 w-64 glass-panel neon-border-gold rounded-lg shadow-xl z-[60] max-h-80 overflow-y-auto">
                    <div class="p-2 border-b border-gray-700 text-xs font-bold text-center">الإشعارات</div>
                    <div id="notiList" class="p-2 text-xs space-y-2"></div>
                </div>
            </div>

            <button id="themeToggle" class="p-2 rounded-full hover:bg-white/10 transition">
                <i class="fas fa-sun text-yellow-400"></i>
            </button>
            <button id="langToggle" class="px-3 py-1 rounded border border-[#FFD700] text-[#FFD700] hover:bg-[#FFD700] hover:text-black transition font-bold">
                English
            </button>
        </div>
    </nav>

    <main id="app" class="flex-grow container mx-auto p-4 relative">
        </main>

    <footer class="text-center py-4 text-gray-500 text-sm glass-panel mt-8">
        Designed & Developed by <span class="text-[#FFD700]">NOUR NADY</span> &copy; 2026
    </footer>

    <div id="toast" class="fixed bottom-5 left-5 hidden z-[100]">
        <div class="glass-panel neon-border-gold px-6 py-3 rounded-lg flex items-center gap-3">
            <i id="toastIcon" class="fas fa-info-circle text-[#FFD700]"></i>
            <span id="toastMsg" class="font-semibold"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, setDoc, getDoc, arrayUnion, arrayRemove, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnGRKtuNq37uFTVs4n16jWshKu5rMaXnQ",
            authDomain: "project-3403979804090393783.firebaseapp.com",
            projectId: "project-3403979804090393783",
            storageBucket: "project-3403979804090393783.firebasestorage.app",
            messagingSenderId: "200296118651",
            appId: "1:200296118651:web:aff0e8f1615f2bdb78a5de",
            measurementId: "G-ZNF0M7D6J9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        let currentUser = null;
        let userData = null;
        let currentLang = 'ar';
        let geminiApiKey = localStorage.getItem('gemini_api_key') || '';
        let currentExamQuestions = [];
        
        const ADMIN_EMAIL = "noornady00@gmail.com";
        const ADMIN_PASS = "noornady2007";

        const dictionary = {
            ar: {
                welcome: "مرحباً ي",
                subtitle: "منصه لطلاب كلية التربية - قسم الرياضيات",
                student: "طالب",
                admin: "مشرف",
                login: "تسجيل الدخول",
                signup: "إنشاء حساب جديد",
                email: "البريد الإلكتروني",
                password: "كلمة المرور",
                name: "الاسم ",
                phone: "رقم الهاتف",
                year: "الفرقة الدراسية",
                year1: "الفرقة الأولى",
                year2: "الفرقة الثانية",
                year3: "الفرقة الثالثة",
                year4: "الفرقة الرابعة",
                confirmPass: "تأكيد كلمة المرور",
                submit: "إرسال الطلب",
                waitApproval: "تم إرسال طلبك بنجاح! يرجى انتظار موافقة المشرف خلال 24 ساعة.",
                dashboard: "لوحة التحكم",
                courses: "المواد الدراسية",
                exams: "الامتحانات",
                files: "الملفات",
                requests: "طلبات التسجيل",
                students: "الطلاب",
                aiAssistant: "المساعد الذكي",
                settings: "الإعدادات",
                logout: "تسجيل الخروج",
                addCourse: "إضافة كورس",
                addExam: "إضافة امتحان",
                manual: "يدوي",
                ai: "ذكاء اصطناعي",
                approve: "موافقة",
                reject: "رفض",
                delete: "حذف",
                view: "عرض",
                score: "الدرجة",
                explanation: "التفسير",
                correct: "إجابة صحيحة",
                wrong: "إجابة خاطئة",
                send: "إرسال",
                typeMsg: "اكتب رسالتك هنا...",
                saveApiKey: "حفظ مفتاح Gemini API",
                enterApiKey: "أدخل مفتاح Gemini API لتفعيل الذكاء الاصطناعي",
                noData: "لا توجد بيانات حالياً",
                videoLink: "رابط يوتيوب",
                desc: "الوصف",
                title: "العنوان",
                subject: "المادة",
                create: "إنشاء",
                questionsCount: "عدد الأسئلة",
                examType: "نوع السؤال",
                mcq: "اختر من متعدد",
                tf: "صح وخطأ",
                essay: "مقالي",
                generating: "جارٍ التوليد بالذكاء الاصطناعي...",
                examResult: "نتيجة الامتحان",
                showAns: "عرض الإجابات",
                yourAns: "إجابتك",
                correctAns: "الإجابة الصحيحة",
                uploadFile: "رفع ملف (رابط)",
                link: "الرابط",
                fileType: "نوع الملف",
                drive: "جوجل درايف",
                local: "من الجهاز",
                aboutDev: "تم تطوير وبرمجة المنصة بواسطة نور نادي",
                addQuestion: "إضافة السؤال للقائمة",
                question: "السؤال",
                options: "الاختيارات (افصل بـ فاصلة)",
                correctAnswer: "الإجابة الصحيحة أو الحرف (A,B,C..)"
            },
            en: {
                welcome: "Welcome to ",
                subtitle: "The leading platform for Faculty of Education - Math Dept",
                student: "Student",
                admin: "Admin",
                login: "Login",
                signup: "Sign Up",
                email: "Email",
                password: "Password",
                name: "Full Name",
                phone: "Phone Number",
                year: "Academic Year",
                year1: "First Year",
                year2: "Second Year",
                year3: "Third Year",
                year4: "Fourth Year",
                confirmPass: "Confirm Password",
                submit: "Submit Request",
                waitApproval: "Request sent successfully! Please wait for admin approval within 24 hours.",
                dashboard: "Dashboard",
                courses: "Courses",
                exams: "Exams",
                files: "Files",
                requests: "Requests",
                students: "Students",
                aiAssistant: "AI Assistant",
                settings: "Settings",
                logout: "Logout",
                addCourse: "Add Course",
                addExam: "Add Exam",
                manual: "Manual",
                ai: "AI Generated",
                approve: "Approve",
                reject: "Reject",
                delete: "Delete",
                view: "View",
                score: "Score",
                explanation: "Explanation",
                correct: "Correct",
                wrong: "Wrong",
                send: "Send",
                typeMsg: "Type your message...",
                saveApiKey: "Save Gemini API Key",
                enterApiKey: "Enter Gemini API Key to enable AI",
                noData: "No data available",
                videoLink: "YouTube Link",
                desc: "Description",
                title: "Title",
                subject: "Subject",
                create: "Create",
                questionsCount: "Question Count",
                examType: "Question Type",
                mcq: "Multiple Choice",
                tf: "True/False",
                essay: "Essay",
                generating: "Generating with AI...",
                examResult: "Exam Result",
                showAns: "Show Answers",
                yourAns: "Your Answer",
                correctAns: "Correct Answer (A,B,C..)",
                uploadFile: "Upload File (Link)",
                link: "Link",
                fileType: "File Type",
                drive: "Google Drive",
                local: "Local Device",
                aboutDev: "Developed by Nour Nady",
                addQuestion: "Add Question to List",
                question: "Question",
                options: "Options (separate by comma)",
                correctAnswer: "Correct Answer"
            }
        };

        const t = (key) => dictionary[currentLang][key] || key;

        const showToast = (msg, type = 'info') => {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            const toastIcon = document.getElementById('toastIcon');
            
            toastMsg.textContent = msg;
            toastIcon.className = type === 'success' ? 'fas fa-check-circle text-green-400' : 
                                  type === 'error' ? 'fas fa-exclamation-circle text-red-500' : 
                                  'fas fa-info-circle text-[#FFD700]';
            
            toast.classList.remove('hidden');
            toast.classList.add('animate-fade-in');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        const render = (html) => {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = html;
        };

        const toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            const icon = document.querySelector('#themeToggle i');
            if(document.body.classList.contains('light-mode')) {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                icon.classList.replace('text-yellow-400', 'text-purple-600');
            } else {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                icon.classList.replace('text-purple-600', 'text-yellow-400');
            }
        };

        const toggleLang = () => {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;
            document.getElementById('langToggle').textContent = currentLang === 'ar' ? 'English' : 'العربية';
            router(); 
        };

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('langToggle').addEventListener('click', toggleLang);

        // --- Notifications Logic ---
        const sendNotification = async (msg) => {
            await addDoc(collection(db, "notifications"), {
                message: msg,
                createdAt: new Date().toISOString()
            });
        };

        const listenToNotifications = () => {
            const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(10));
            onSnapshot(q, (snapshot) => {
                const notiList = document.getElementById('notiList');
                const dot = document.getElementById('notificationDot');
                if(!notiList) return;
                
                if(!snapshot.empty) dot.style.display = 'block';
                
                notiList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-white/5 rounded border-b border-gray-800 text-[10px]';
                    item.innerHTML = `<strong>${data.message}</strong><br><span class="text-gray-500">${new Date(data.createdAt).toLocaleString('ar-EG')}</span>`;
                    notiList.appendChild(item);
                });
            });
        };

        document.getElementById('notiToggle').addEventListener('click', () => {
            const menu = document.getElementById('notiMenu');
            menu.classList.toggle('hidden');
            document.getElementById('notificationDot').style.display = 'none';
        });

        const views = {
            auth: () => `
                <div class="flex flex-col items-center justify-center min-h-[80vh] w-full animate-fade-in">
                    <div class="text-center mb-10">
                        <h1 class="text-5xl font-bold mb-4 neon-text-gold">NOUR.NADY</h1>
                        <p class="text-xl text-gray-300">${t('subtitle')}</p>
                        <div class="mt-4 text-sm text-purple-400 font-mono">${t('aboutDev')}</div>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl w-full max-w-md neon-border-purple">
                        <div class="flex mb-6 border-b border-gray-700">
                            <button onclick="window.setAuthMode('login')" class="flex-1 pb-2 text-center ${authMode === 'login' ? 'text-[#FFD700] border-b-2 border-[#FFD700]' : 'text-gray-400'}">${t('login')}</button>
                            <button onclick="window.setAuthMode('signup')" class="flex-1 pb-2 text-center ${authMode === 'signup' ? 'text-[#FFD700] border-b-2 border-[#FFD700]' : 'text-gray-400'}">${t('signup')}</button>
                        </div>
                        <form id="authForm" class="flex flex-col gap-4">
                            ${authMode === 'signup' ? `
                                <input type="text" id="name" placeholder="${t('name')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                                <input type="tel" id="phone" placeholder="${t('phone')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                                <select id="year" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition">
                                    <option value="1">${t('year1')}</option>
                                    <option value="2">${t('year2')}</option>
                                    <option value="3">${t('year3')}</option>
                                    <option value="4">${t('year4')}</option>
                                </select>
                            ` : ''}
                            <input type="email" id="email" placeholder="${t('email')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                            <input type="password" id="password" placeholder="${t('password')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                            ${authMode === 'signup' ? `
                                <input type="password" id="confirmPass" placeholder="${t('confirmPass')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                            ` : ''}
                            <button type="submit" class="mt-4 bg-gradient-to-r from-purple-900 to-black border border-[#FFD700] text-[#FFD700] py-3 rounded font-bold hover:shadow-[0_0_15px_rgba(255,215,0,0.5)] transition uppercase tracking-wide">
                                ${authMode === 'login' ? t('login') : t('submit')}
                            </button>
                        </form>
                    </div>
                </div>
            `,
            adminDashboard: () => `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 animate-fade-in h-full">
                    <div class="glass-panel p-4 rounded-xl md:col-span-1 h-fit neon-border-purple">
                        <div class="flex flex-col gap-2">
                            <button onclick="window.setAdminTab('requests')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'requests' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-user-clock w-6"></i> ${t('requests')}</button>
                            <button onclick="window.setAdminTab('students')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'students' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-users w-6"></i> ${t('students')}</button>
                            <button onclick="window.setAdminTab('courses')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'courses' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-book w-6"></i> ${t('courses')}</button>
                            <button onclick="window.setAdminTab('exams')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'exams' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-pen-alt w-6"></i> ${t('exams')}</button>
                            <button onclick="window.setAdminTab('files')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'files' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-file-alt w-6"></i> ${t('files')}</button>
                            <button onclick="window.setAdminTab('settings')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'settings' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-cog w-6"></i> ${t('settings')}</button>
                            <button onclick="handleLogout()" class="p-3 text-start rounded hover:bg-red-900/30 text-red-400 mt-4 border-t border-gray-700"><i class="fas fa-sign-out-alt w-6"></i> ${t('logout')}</button>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl md:col-span-3 min-h-[600px] neon-border-gold overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-6 text-[#FFD700] border-b border-gray-700 pb-2">${t(adminTab)}</h2>
                        <div id="adminContent">Loading...</div>
                    </div>
                </div>
            `,
            studentDashboard: () => `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold neon-text-gold">${t('welcome')}, ${userData?.name}</h2>
                        <div class="flex gap-2">
                             <button onclick="window.openAiChat()" class="glass-panel px-4 py-2 rounded text-purple-400 hover:text-white hover:bg-purple-900/50 transition border border-purple-500">
                                <i class="fas fa-robot mr-2"></i> ${t('aiAssistant')}
                            </button>
                            <button onclick="handleLogout()" class="glass-panel px-4 py-2 rounded text-red-400 hover:bg-red-900/20 transition"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-panel p-6 rounded-xl neon-border-purple h-fit">
                            <h3 class="text-xl font-bold mb-4 text-purple-300">${t('settings')}</h3>
                            <div class="space-y-3 text-sm">
                                <p><span class="text-gray-400">${t('name')}:</span> ${userData?.name}</p>
                                <p><span class="text-gray-400">${t('year')}:</span> ${t('year'+userData?.year)}</p>
                                <p><span class="text-gray-400">${t('phone')}:</span> ${userData?.phone}</p>
                            </div>
                        </div>
                        <div class="md:col-span-2 glass-panel p-6 rounded-xl neon-border-gold">
                            <h3 class="text-xl font-bold mb-4 text-[#FFD700]">${t('courses')}</h3>
                            <div id="studentCoursesList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>
            `,
            courseView: () => `
                <div class="animate-fade-in">
                    <button onclick="window.location.reload()" class="mb-4 text-gray-400 hover:text-white"><i class="fas fa-arrow-right rtl:rotate-180"></i> ${t('dashboard')}</button>
                    <h2 class="text-3xl font-bold neon-text-gold mb-6">${selectedCourse.name}</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                             <div class="glass-panel p-4 rounded-xl">
                                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fab fa-youtube text-red-500"></i> Lectures</h3>
                                <div id="videoList" class="space-y-4"></div>
                             </div>
                        </div>
                        <div class="space-y-6">
                             <div class="glass-panel p-4 rounded-xl neon-border-purple">
                                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fas fa-clipboard-check text-green-400"></i> ${t('exams')}</h3>
                                <div id="examList" class="space-y-2"></div>
                             </div>
                             <div class="glass-panel p-4 rounded-xl">
                                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fas fa-folder-open text-yellow-400"></i> ${t('files')}</h3>
                                <div id="fileList" class="space-y-2"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `,
            examView: () => `
                <div class="max-w-3xl mx-auto glass-panel p-8 rounded-xl neon-border-gold animate-fade-in relative">
                    <button onclick="window.exitExam()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    <h2 class="text-2xl font-bold mb-2 text-[#FFD700]">${selectedExam.title}</h2>
                    <p class="text-gray-400 mb-6 text-sm">${selectedExam.description || ''}</p>
                    <div id="examQuestions" class="space-y-8"></div>
                    <button id="submitExamBtn" onclick="submitExam()" class="mt-8 w-full bg-[#FFD700] text-black font-bold py-3 rounded hover:bg-yellow-400 transition">${t('submit')}</button>
                    <div id="examResultPanel" class="hidden mt-8 p-4 bg-black/40 rounded border border-purple-500">
                        <h3 class="text-2xl font-bold text-center text-white mb-2">${t('examResult')}</h3>
                        <div id="scoreDisplay" class="text-4xl font-bold text-center text-[#FFD700] mb-4"></div>
                        <div id="explanations" class="space-y-4 text-sm"></div>
                    </div>
                </div>
            `,
            aiChat: () => `
                <div class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-[#0a0a0a] w-full max-w-2xl h-[80vh] rounded-xl neon-border-purple flex flex-col relative glass-panel">
                        <button onclick="closeAiChat()" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                        <div class="p-4 border-b border-purple-900">
                            <h3 class="text-xl font-bold text-purple-400"><i class="fas fa-robot"></i> NOUR.AI Assistant</h3>
                            <p class="text-xs text-gray-500">Powered by Gemini - Ask about math, upload problems, or explain concepts.</p>
                        </div>
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                            <div class="flex justify-start"><div class="bg-purple-900/30 text-gray-200 p-3 rounded-lg rounded-tl-none max-w-[80%]">Welcome! How can I help you with your math studies today?</div></div>
                        </div>
                        <div class="p-4 border-t border-purple-900 bg-black/20">
                            <div class="flex gap-2">
                                <input type="text" id="aiInput" placeholder="${t('typeMsg')}" class="flex-1 bg-black/50 border border-gray-700 rounded p-2 text-white outline-none focus:border-purple-500">
                                <button onclick="sendAiMessage()" class="p-2 bg-purple-600 rounded text-white hover:bg-purple-500"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        let authMode = 'login';
        let adminTab = 'requests';
        let selectedCourse = null;
        let selectedExam = null;
        let showAiChat = false;

        window.setAuthMode = (mode) => { authMode = mode; router(); };
        window.setAdminTab = (tab) => { adminTab = tab; router(); loadAdminData(); };
        window.openAiChat = () => { showAiChat = true; router(); };
        window.closeAiChat = () => { showAiChat = false; router(); };
        window.exitExam = () => { selectedExam = null; router(); };

        const handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                if(authMode === 'login') {
                    if(email === ADMIN_EMAIL && password === ADMIN_PASS) {
                        currentUser = { email: ADMIN_EMAIL, role: 'admin', uid: 'admin_001' };
                        router();
                        return;
                    }
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        if(data.status === 'pending') {
                            await signOut(auth);
                            showToast(t('waitApproval'), 'error');
                        } else if (data.status === 'rejected') {
                             await signOut(auth);
                             showToast("Access Denied.", 'error');
                        } else {
                            userData = data;
                            currentUser = user;
                            router();
                        }
                    }
                } else {
                    if(document.getElementById('password').value !== document.getElementById('confirmPass').value) {
                        showToast("Passwords do not match", 'error');
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, "users", user.uid), {
                        name: document.getElementById('name').value,
                        phone: document.getElementById('phone').value,
                        year: document.getElementById('year').value,
                        email: email,
                        status: 'pending',
                        role: 'student',
                        createdAt: new Date()
                    });
                    showToast(t('waitApproval'), 'success');
                    await signOut(auth);
                    window.setAuthMode('login');
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            currentUser = null;
            userData = null;
            selectedCourse = null;
            router();
        };

        const loadAdminData = async () => {
            const container = document.getElementById('adminContent');
            if(!container) return;
            container.innerHTML = '<div class="loader mx-auto w-8 h-8 rounded-full border-4 border-gray-200"></div>';

            if(adminTab === 'settings') {
                container.innerHTML = `
                    <div class="space-y-4">
                        <label class="block text-gray-400">${t('enterApiKey')}</label>
                        <input type="text" id="apiKeyInput" value="${geminiApiKey}" class="w-full p-3 bg-black/50 border border-purple-900 rounded text-white">
                        <button onclick="saveApiKey()" class="bg-[#FFD700] text-black px-4 py-2 rounded font-bold">${t('saveApiKey')}</button>
                    </div>
                `;
                return;
            }

            if(adminTab === 'requests') {
                const q = query(collection(db, "users"), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) { container.innerHTML = `<p class="text-gray-500">${t('noData')}</p>`; return; }
                let html = '<div class="space-y-4">';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    html += `<div class="glass-panel p-4 rounded flex justify-between items-center">
                        <div><h4 class="font-bold text-[#FFD700]">${data.name}</h4><p class="text-sm text-gray-400">${data.email}</p></div>
                        <div class="flex gap-2">
                            <button onclick="updateUserStatus('${doc.id}', 'approved')" class="px-3 py-1 bg-green-600/20 text-green-400 border border-green-600 rounded">${t('approve')}</button>
                            <button onclick="updateUserStatus('${doc.id}', 'rejected')" class="px-3 py-1 bg-red-600/20 text-red-400 border border-red-600 rounded">${t('reject')}</button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html + '</div>';
            }

            if(adminTab === 'students') {
                const q = query(collection(db, "users"), where("role", "==", "student"), where("status", "==", "approved"));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) { container.innerHTML = `<p class="text-gray-500">${t('noData')}</p>`; return; }
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    html += `<div class="glass-panel p-4 rounded relative border-gray-800">
                        <h4 class="font-bold text-[#FFD700]">${data.name}</h4>
                        <p class="text-xs text-gray-400">Email: ${data.email}</p>
                        <p class="text-xs text-gray-400">Phone: ${data.phone}</p>
                        <p class="text-xs text-gray-400">Year: ${t('year'+data.year)}</p>
                        <button onclick="deleteUser('${docSnap.id}')" class="absolute top-2 right-2 text-red-500 hover:text-red-400 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                });
                container.innerHTML = html + '</div>';
            }

            if(adminTab === 'courses') {
                const querySnapshot = await getDocs(collection(db, "courses"));
                let html = `<div class="mb-4"><button onclick="addNewCourse()" class="bg-[#FFD700] text-black px-4 py-2 rounded font-bold">+ ${t('addCourse')}</button></div>`;
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    html += `<div class="glass-panel p-4 rounded relative group border-gray-800">
                        <h4 class="font-bold text-lg text-[#FFD700]">${data.name}</h4>
                        <div class="mt-4 flex flex-col gap-2">
                            <input type="text" placeholder="YouTube Link" id="vid-${docSnap.id}" class="bg-black/30 p-1 text-sm rounded border border-gray-700 text-white">
                            <input type="text" placeholder="Title" id="title-${docSnap.id}" class="bg-black/30 p-1 text-sm rounded border border-gray-700 text-white">
                            <button onclick="addVideoToCourse('${docSnap.id}')" class="text-xs bg-purple-600 py-1 rounded">Add Video</button>
                        </div>
                        <div class="mt-4 border-t border-gray-700 pt-2">
                            <p class="text-xs text-gray-500 mb-2 font-bold">المحتوى الحالي:</p>
                            ${(data.videos || []).map(v => `<div class="flex justify-between text-xs bg-white/5 p-1 mb-1 rounded">
                                <span class="truncate w-32"><i class="fab fa-youtube text-red-500 mr-1"></i> ${v.title}</span>
                                <button onclick="deleteVideo('${docSnap.id}', '${v.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                            </div>`).join('')}
                            ${(data.files || []).map(f => `<div class="flex justify-between text-xs bg-blue-900/10 p-1 mb-1 rounded border border-blue-900/20">
                                <span class="truncate w-32"><i class="fas fa-file-pdf text-blue-400 mr-1"></i> ${f.name}</span>
                                <button onclick="deleteFile('${docSnap.id}', '${f.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                            </div>`).join('')}
                            ${(data.exams || []).map(e => `<div class="flex justify-between text-xs bg-green-900/10 p-1 mb-1 rounded border border-green-900/20">
                                <span class="truncate w-32"><i class="fas fa-pen-alt text-green-400 mr-1"></i> ${e.title}</span>
                                <button onclick="deleteExam('${docSnap.id}', '${e.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                            </div>`).join('')}
                        </div>
                        <button onclick="deleteCourse('${docSnap.id}')" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                });
                container.innerHTML = html + '</div>';
            }

            if(adminTab === 'exams') {
                 currentExamQuestions = [];
                 const coursesSnap = await getDocs(collection(db, "courses"));
                 let options = '';
                 coursesSnap.forEach(d => options += `<option value="${d.id}">${d.data().name}</option>`);
                 container.innerHTML = `
                    <div class="space-y-6">
                        <div class="glass-panel p-6 rounded-xl border-purple-900/50">
                            <h3 class="text-xl text-[#FFD700] mb-4 font-bold border-b border-gray-800 pb-2">${t('addExam')}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">${t('courses')}</label>
                                    <select id="examCourse" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">${options}</select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">${t('title')}</label>
                                    <input type="text" id="examTitle" placeholder="${t('title')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">
                                </div>
                            </div>

                            <div class="glass-panel p-4 rounded-lg bg-white/5 space-y-4">
                                <h4 class="text-[#8A2BE2] font-bold"><i class="fas fa-plus-circle"></i> إضافة سؤال جديد</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <select id="qType" onchange="window.toggleQuestionOptions()" class="p-2 bg-black/50 border border-gray-600 rounded text-white">
                                        <option value="mcq">${t('mcq')}</option>
                                        <option value="tf">${t('tf')}</option>
                                        <option value="essay">${t('essay')}</option>
                                    </select>
                                    <input type="text" id="qText" placeholder="${t('question')}" class="p-2 bg-black/50 border border-gray-600 rounded text-white">
                                </div>
                                <div id="optionsContainer">
                                    <input type="text" id="qOptions" placeholder="${t('options')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="qCorrect" placeholder="${t('correctAnswer')}" class="p-2 bg-black/50 border border-gray-600 rounded text-white">
                                    <input type="text" id="qExplain" placeholder="${t('explanation')}" class="p-2 bg-black/50 border border-gray-600 rounded text-white">
                                </div>
                                <button onclick="window.addQuestionToTempList()" class="w-full py-2 bg-purple-900/50 border border-purple-500 text-purple-200 rounded hover:bg-purple-500 hover:text-white transition">
                                    ${t('addQuestion')}
                                </button>
                            </div>

                            <div class="mt-6">
                                <h4 class="text-sm text-gray-400 mb-2">الأسئلة المضافة (<span id="qTempCount">0</span>)</h4>
                                <div id="tempQuestionsList" class="space-y-2 max-h-40 overflow-y-auto mb-4"></div>
                                <button onclick="createExam()" class="w-full bg-[#FFD700] text-black font-bold py-3 rounded hover:shadow-[0_0_15px_rgba(255,215,0,0.4)] transition">
                                    ${t('create')}
                                </button>
                            </div>
                        </div>
                    </div>
                 `;
            }

            if(adminTab === 'files') {
                 const coursesSnap = await getDocs(collection(db, "courses"));
                 let options = '';
                 coursesSnap.forEach(d => options += `<option value="${d.id}">${d.data().name}</option>`);
                 container.innerHTML = `<div class="glass-panel p-6 rounded"><h3 class="text-xl text-[#FFD700] mb-4">${t('uploadFile')}</h3><div class="space-y-4">
                    <select id="fileCourse" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">${options}</select>
                    <input type="text" id="fileName" placeholder="${t('title')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">
                    <input type="url" id="fileUrl" placeholder="${t('link')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">
                    <button onclick="addFileToCourse()" class="bg-green-600 text-white px-4 py-2 rounded w-full">${t('create')}</button>
                 </div></div>`;
            }
        };

        window.toggleQuestionOptions = () => {
            const type = document.getElementById('qType').value;
            const container = document.getElementById('optionsContainer');
            if(type === 'mcq') container.classList.remove('hidden');
            else container.classList.add('hidden');
        };

        window.addQuestionToTempList = () => {
            const q = document.getElementById('qText').value;
            const type = document.getElementById('qType').value;
            let correct = document.getElementById('qCorrect').value.trim();
            const explain = document.getElementById('qExplain').value;
            let options = [];

            if(type === 'mcq') {
                options = document.getElementById('qOptions').value.split(',').map(s => s.trim());
                const alpha = ['A', 'B', 'C', 'D', 'E'];
                if(alpha.includes(correct.toUpperCase())) {
                    const idx = alpha.indexOf(correct.toUpperCase());
                    if(options[idx]) correct = options[idx];
                }
            } else if(type === 'tf') {
                options = [currentLang === 'ar' ? 'صح' : 'True', currentLang === 'ar' ? 'خطأ' : 'False'];
                if(correct === '1' || correct.toLowerCase() === 'true' || correct === 'صح') correct = options[0];
                if(correct === '0' || correct.toLowerCase() === 'false' || correct === 'خطأ') correct = options[1];
            }

            if(!q || !correct) { showToast("برجاء إكمال بيانات السؤال", "error"); return; }
            currentExamQuestions.push({ q, type, options, answer: correct, explain });
            document.getElementById('qTempCount').textContent = currentExamQuestions.length;
            const list = document.getElementById('tempQuestionsList');
            const item = document.createElement('div');
            item.className = 'text-xs bg-white/5 p-2 rounded flex justify-between border-l-2 border-purple-500';
            item.innerHTML = `<span>${q}</span><span class="text-gray-500">${type}</span>`;
            list.appendChild(item);
            document.getElementById('qText').value = '';
            document.getElementById('qCorrect').value = '';
            document.getElementById('qExplain').value = '';
            if(type === 'mcq') document.getElementById('qOptions').value = '';
            showToast("تمت إضافة السؤال للقائمة", "success");
        };

        window.createExam = async () => {
            const courseId = document.getElementById('examCourse').value;
            const title = document.getElementById('examTitle').value;
            if(!title || currentExamQuestions.length === 0) { showToast("أدخل العنوان وأضف أسئلة أولاً", "error"); return; }
            try {
                const examObj = { id: Date.now().toString(), title, questions: currentExamQuestions, createdAt: new Date().toISOString() };
                await updateDoc(doc(db, "courses", courseId), { exams: arrayUnion(examObj) });
                await sendNotification(`تمت إضافة امتحان جديد: ${title}`);
                showToast("تم إنشاء الامتحان بنجاح", "success");
                loadAdminData();
            } catch(e) { showToast("خطأ في حفظ الامتحان", "error"); }
        };

        window.deleteUser = async (id) => {
            if(confirm("Are you sure you want to delete this student?")) {
                await deleteDoc(doc(db, "users", id));
                showToast("User Deleted", "success");
                loadAdminData();
            }
        };

        window.addNewCourse = async () => {
            const name = prompt("Enter Course Name / أدخل اسم الكورس:");
            if(!name) return;
            try {
                await addDoc(collection(db, "courses"), { name: name, videos: [], files: [], exams: [] });
                await sendNotification(`تمت إضافة كورس جديد: ${name}`);
                showToast("Course Added Successfully", "success");
                loadAdminData();
            } catch(e) { showToast("Error adding course", "error"); }
        };

        window.deleteCourse = async (id) => {
            if(confirm("Delete this course?")) {
                await deleteDoc(doc(db, "courses", id));
                loadAdminData();
            }
        };

        window.deleteVideo = async (courseId, videoId) => {
            if(!confirm("Delete this video?")) return;
            const courseRef = doc(db, "courses", courseId);
            const snap = await getDoc(courseRef);
            const videos = snap.data().videos || [];
            const updated = videos.filter(v => v.id !== videoId);
            await updateDoc(courseRef, { videos: updated });
            loadAdminData();
        };

        window.deleteExam = async (courseId, examId) => {
            if(!confirm("هل أنت متأكد من حذف هذا الامتحان؟")) return;
            const courseRef = doc(db, "courses", courseId);
            const snap = await getDoc(courseRef);
            const exams = snap.data().exams || [];
            const updated = exams.filter(e => e.id !== examId);
            await updateDoc(courseRef, { exams: updated });
            showToast("تم حذف الامتحان", "success");
            loadAdminData();
        };

        window.deleteFile = async (courseId, fileId) => {
            if(!confirm("هل أنت متأكد من حذف هذا الملف؟")) return;
            const courseRef = doc(db, "courses", courseId);
            const snap = await getDoc(courseRef);
            const files = snap.data().files || [];
            const updated = files.filter(f => f.id !== fileId);
            await updateDoc(courseRef, { files: updated });
            showToast("تم حذف الملف", "success");
            loadAdminData();
        };

        window.addVideoToCourse = async (courseId) => {
            const link = document.getElementById(`vid-${courseId}`).value;
            const title = document.getElementById(`title-${courseId}`).value;
            if(!link) return;
            let videoId = link.includes('v=') ? link.split('v=')[1].split('&')[0] : link.split('/').pop();
            const videoObj = { id: Date.now().toString(), title: title || 'Lesson', url: `https://www.youtube.com/embed/${videoId}`, originalLink: link };
            await updateDoc(doc(db, "courses", courseId), { videos: arrayUnion(videoObj) });
            await sendNotification(`تم رفع فيديو جديد: ${title}`);
            showToast("Video Added", 'success');
            loadAdminData();
        };

        window.addFileToCourse = async () => {
             const courseId = document.getElementById('fileCourse').value;
             const name = document.getElementById('fileName').value;
             const url = document.getElementById('fileUrl').value;
             if(!url) return;
             await updateDoc(doc(db, "courses", courseId), { files: arrayUnion({ id: Date.now().toString(), name, url, date: new Date().toISOString() }) });
             await sendNotification(`تم رفع ملف جديد: ${name}`);
             showToast("File Added", 'success');
             loadAdminData();
        };

        window.updateUserStatus = async (uid, status) => {
            await updateDoc(doc(db, "users", uid), { status: status });
            loadAdminData();
        };

        window.saveApiKey = () => {
            const key = document.getElementById('apiKeyInput').value;
            localStorage.setItem('gemini_api_key', key);
            geminiApiKey = key;
            showToast("API Key Saved", 'success');
        };

        const renderStudentCourses = async () => {
            const list = document.getElementById('studentCoursesList');
            if(!list) return;
            const snapshot = await getDocs(collection(db, "courses"));
            list.innerHTML = '';
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const el = document.createElement('div');
                el.className = 'glass-panel p-4 rounded hover:bg-white/5 cursor-pointer transition flex items-center justify-between group';
                el.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-book text-purple-400 text-xl"></i><span class="font-bold text-lg">${data.name}</span></div><i class="fas fa-chevron-left text-gray-500 group-hover:text-[#FFD700] rtl:rotate-180"></i>`;
                el.onclick = () => { selectedCourse = { id: docSnap.id, ...data }; router(); };
                list.appendChild(el);
            });
        };

        const renderCourseContent = () => {
            const vidList = document.getElementById('videoList');
            const fileList = document.getElementById('fileList');
            const examList = document.getElementById('examList');
            vidList.innerHTML = (selectedCourse.videos || []).map(v => `<div class="mb-6"><div class="aspect-video w-full rounded-lg overflow-hidden border border-gray-800 bg-black"><iframe src="${v.url}" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div><div class="flex justify-between mt-2"><h4 class="font-bold text-[#FFD700]">${v.title}</h4><a href="${v.originalLink}" target="_blank" class="text-xs bg-red-600 text-white px-2 py-1 rounded">YouTube</a></div></div>`).join('') || 'No videos.';
            examList.innerHTML = (selectedCourse.exams || []).map((e, idx) => `<div onclick="startExam(${idx})" class="p-3 bg-white/5 rounded hover:bg-white/10 cursor-pointer flex justify-between items-center transition"><span>${e.title}</span><i class="fas fa-play text-green-400"></i></div>`).join('') || 'No exams.';
            fileList.innerHTML = (selectedCourse.files || []).map(f => `<a href="${f.url}" target="_blank" class="p-3 bg-white/5 rounded hover:bg-white/10 flex justify-between items-center transition block"><span>${f.name}</span><i class="fas fa-download text-blue-400"></i></a>`).join('') || 'No files.';
        };

        window.startExam = (index) => { selectedExam = selectedCourse.exams[index]; router(); renderExam(); };

        const renderExam = () => {
            const container = document.getElementById('examQuestions');
            const alpha = ['A', 'B', 'C', 'D', 'E', 'F'];
            container.innerHTML = selectedExam.questions.map((q, i) => {
                let optionsHtml = '';
                if(q.type === 'essay') {
                    optionsHtml = `<textarea name="q${i}" class="w-full p-3 bg-white/5 rounded border border-gray-700 text-white outline-none focus:border-purple-500" placeholder="اكتب إجابتك هنا..."></textarea>`;
                } else {
                    optionsHtml = `<div class="space-y-2">${q.options.map((opt, idx) => `
                        <label class="flex items-center gap-3 p-3 rounded bg-white/5 cursor-pointer hover:bg-white/10">
                            <input type="radio" name="q${i}" value="${opt}" class="accent-purple-500 w-4 h-4">
                            <span class="text-[#FFD700] font-bold">${q.type === 'mcq' ? alpha[idx] + ') ' : ''}</span>
                            <span>${opt}</span>
                        </label>`).join('')}</div>`;
                }
                return `<div class="bg-black/30 p-4 rounded border border-gray-700 q-block" id="q-${i}">
                    <p class="font-bold text-lg mb-4"><span class="text-[#FFD700]">Q${i+1}:</span> ${q.q}</p>
                    ${optionsHtml}
                    <div class="hidden mt-3 p-3 rounded bg-purple-900/30 border border-purple-500 text-sm explanation-box">
                        <p class="font-bold text-green-400">${q.type === 'essay' ? 'الإجابة النموذجية' : 'الإجابة الصحيحة'}: ${q.answer}</p>
                        <p class="mt-1 text-gray-300">${q.explain || ''}</p>
                    </div>
                </div>`;
            }).join('');
        };

        window.submitExam = () => {
            let score = 0;
            document.querySelectorAll('.q-block').forEach((block, i) => {
                const qData = selectedExam.questions[i];
                let isCorrect = false;
                if(qData.type === 'essay') {
                    const typed = block.querySelector(`textarea[name="q${i}"]`).value;
                    isCorrect = typed.length > 5;
                } else {
                    const selected = block.querySelector(`input[name="q${i}"]:checked`);
                    isCorrect = selected && selected.value === qData.answer;
                }
                block.querySelector('.explanation-box').classList.remove('hidden');
                if(isCorrect) { 
                    if(qData.type !== 'essay') score++; 
                    block.classList.add('border-green-500'); 
                } else { 
                    block.classList.add('border-red-500'); 
                }
            });
            document.getElementById('examResultPanel').classList.remove('hidden');
            document.getElementById('scoreDisplay').textContent = `${score} / ${selectedExam.questions.filter(q => q.type !== 'essay').length}`;
            document.getElementById('submitExamBtn').classList.add('hidden');
        };

        window.sendAiMessage = async () => {
            const input = document.getElementById('aiInput');
            const msg = input.value; if(!msg) return;
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML += `<div class="flex justify-end"><div class="bg-[#FFD700] text-black p-3 rounded-lg max-w-[80%]">${msg}</div></div>`;
            input.value = '';
            if(!geminiApiKey) { chatContainer.innerHTML += `<div class="flex justify-start"><div class="bg-red-900/50 p-3 rounded-lg">API Key Missing</div></div>`; return; }
            const loadingId = 'loading-' + Date.now();
            chatContainer.innerHTML += `<div id="${loadingId}" class="flex justify-start"><div class="bg-purple-900/30 p-3 rounded-lg">Thinking...</div></div>`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Math tutor, use Markdown." }, { text: msg }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                document.getElementById(loadingId).remove();
                chatContainer.innerHTML += `<div class="flex justify-start markdown-body"><div class="bg-purple-900/30 p-3 rounded-lg max-w-[80%] text-sm">${marked.parse(text)}</div></div>`;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (e) { if(document.getElementById(loadingId)) document.getElementById(loadingId).remove(); }
        };

        const router = () => {
            if (currentUser) {
                if (currentUser.role === 'admin') { render(views.adminDashboard()); loadAdminData(); }
                else if(selectedExam) { render(views.examView()); renderExam(); }
                else if (selectedCourse) { render(views.courseView()); renderCourseContent(); }
                else { render(views.studentDashboard()); renderStudentCourses(); }
                if(showAiChat) { document.body.insertAdjacentHTML('beforeend', views.aiChat()); }
                else { const modal = document.querySelector('.fixed.inset-0.z-50'); if(modal) modal.remove(); }
            } else {
                render(views.auth());
                document.getElementById('authForm').addEventListener('submit', handleAuth);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if(user.email === ADMIN_EMAIL) { currentUser = { ...user, role: 'admin' }; } 
                else {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if(docSnap.exists() && docSnap.data().status === 'approved') { userData = docSnap.data(); currentUser = { ...user, role: 'student' }; }
                    else { await signOut(auth); currentUser = null; }
                }
                listenToNotifications();
            } else { currentUser = null; }
            router();
        });
    </script>
</body>
</html>
