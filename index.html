<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOUR.NADY | Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="IMG_1068.PNG.jpg">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿ™ÿ®ÿ© MathJax ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿπÿßÿØŸÑÿßÿ™ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ© -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          }
        };
    </script>

    <style>
        :root {
            --primary-gold: #FFD700;
            --secondary-purple: #8A2BE2;
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 215, 0, 0.3);
            --text-color: #ffffff;
        }

        body.light-mode {
            --bg-dark: #f0f0f0;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(138, 43, 226, 0.3);
            --text-color: #1a1a1a;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-color);
            transition: all 0.3s ease;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(138, 43, 226, 0.15) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 20%);
            background-attachment: fixed;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .neon-border-gold {
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3), inset 0 0 5px rgba(255, 215, 0, 0.1);
            border: 1px solid var(--primary-gold);
        }

        .neon-border-purple {
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);
            border: 1px solid var(--secondary-purple);
        }

        .neon-text-gold {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            color: var(--primary-gold);
        }

        /* Logo Glow Effect */
        .logo-glow {
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.6), 0 0 5px rgba(255, 215, 0, 0.4);
            border: 2px solid var(--primary-gold);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            object-fit: cover;
            background: black;
        }
        .logo-glow:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.8), 0 0 10px rgba(255, 215, 0, 0.6);
            cursor: pointer;
        }

        /* Profile Pic Glow */
        .profile-glow {
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
            border: 2px solid var(--primary-gold);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .btn-hover {
            transition: all 0.3s ease;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.6);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-gold);
            border-radius: 4px;
        }
        
        .loader {
            border-top-color: var(--primary-gold);
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Markdown Styles */
        .markdown-body p { margin-bottom: 0.5rem; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; margin-right: 1.5rem; margin-bottom: 0.5rem; }
        .markdown-body ol { list-style-type: decimal; margin-right: 1.5rem; margin-bottom: 0.5rem; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: bold; color: #FFD700; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-body code { background: rgba(138, 43, 226, 0.2); padding: 0.2rem 0.4rem; rounded: 4px; font-family: monospace; direction: ltr; display: inline-block; }
        .markdown-body pre { background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px; overflow-x: auto; direction: ltr; margin-bottom: 0.5rem; }
        .markdown-body blockquote { border-right: 3px solid #FFD700; padding-right: 1rem; color: #ccc; font-style: italic; }

        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(255, 0, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Logo Modal -->
    <div id="logoModal" onclick="this.classList.add('hidden')" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center cursor-pointer backdrop-blur-md animate-fade-in">
        <img src="IMG_1068.PNG.jpg" class="max-w-[90%] max-h-[90%] rounded-full shadow-[0_0_50px_rgba(138,43,226,0.5)] border-4 border-[#FFD700]">
    </div>

    <nav class="glass-panel sticky top-0 z-50 px-6 py-3 flex justify-between items-center neon-border-purple border-b-2 border-b-[#8A2BE2] border-0 rounded-none relative">
        <!-- Right Side: Logo -->
        <div class="flex items-center gap-3">
            <img src="IMG_1068.PNG.jpg" onclick="document.getElementById('logoModal').classList.remove('hidden')" alt="Logo" class="w-12 h-12 logo-glow">
            <h1 class="text-2xl font-bold neon-text-gold tracking-widest hidden sm:block">NOUR.NADY</h1>
        </div>

        <!-- Center: User Info (Name & Picture) -->
        <div id="navProfile" class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center gap-3 hidden">
            <!-- Content injected by JS -->
        </div>

        <!-- Left Side: Controls -->
        <div class="flex items-center gap-4">
            <!-- Notification Bell -->
            <div class="relative hidden" id="notifWrapper">
                <button onclick="window.toggleNotifMenu()" class="p-2 rounded-full hover:bg-white/10 transition relative">
                    <i class="fas fa-bell text-[#FFD700] text-xl"></i>
                    <span id="notifBadge" class="absolute top-1 right-1 w-3 h-3 bg-red-600 rounded-full hidden animate-pulse-red border border-black"></span>
                </button>
                <div id="notifDropdown" class="hidden fixed left-1/2 top-20 -translate-x-1/2 w-[90%] sm:absolute sm:top-12 sm:left-0 sm:translate-x-0 sm:w-80 glass-panel rounded-xl max-h-96 overflow-y-auto z-50 neon-border-gold shadow-2xl">
                    <div class="p-3 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur">
                        <h4 class="font-bold text-white">ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h4>
                        <button onclick="window.toggleNotifMenu()" class="text-xs text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="notifList" class="p-2 space-y-2"></div>
                </div>
            </div>

            <button id="themeToggle" class="p-2 rounded-full hover:bg-white/10 transition">
                <i class="fas fa-sun text-yellow-400"></i>
            </button>
            <button id="langToggle" class="px-3 py-1 rounded border border-[#FFD700] text-[#FFD700] hover:bg-[#FFD700] hover:text-black transition font-bold">
                English
            </button>
        </div>
    </nav>

    <main id="app" class="flex-grow container mx-auto p-4 relative">
        </main>

    <footer class="text-center py-4 text-gray-500 text-sm glass-panel mt-8">
        Designed & Developed by <span class="text-[#FFD700]">NOUR NADY</span> &copy; 2026
    </footer>

    <div id="toast" class="fixed bottom-5 left-5 hidden z-[100]">
        <div class="glass-panel neon-border-gold px-6 py-3 rounded-lg flex items-center gap-3">
            <i id="toastIcon" class="fas fa-info-circle text-[#FFD700]"></i>
            <span id="toastMsg" class="font-semibold"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, setDoc, getDoc, arrayUnion, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnGRKtuNq37uFTVs4n16jWshKu5rMaXnQ",
            authDomain: "project-3403979804090393783.firebaseapp.com",
            projectId: "project-3403979804090393783",
            storageBucket: "project-3403979804090393783.firebasestorage.app",
            messagingSenderId: "200296118651",
            appId: "1:200296118651:web:aff0e8f1615f2bdb78a5de",
            measurementId: "G-ZNF0M7D6J9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let currentLang = 'ar';
        
        // Gemini Config - AI Settings
        // In a real production app, never expose keys in client code. Use a backend proxy.
        // For this demo as requested "work for everyone without inputting key":
        const GEMINI_API_KEY = "AIzaSyAxUi90G-9yDHrfYaLJSNTjgaK7QSpdl10"; // Key added here
        
        let currentExamQuestions = [];
        let notifUnsubscribe = null;
        let isSigningUp = false;
        let showSignupSuccess = false;
        
        // AI State
        let selectedAiImage = null; // Stores Base64 of uploaded image

        const ADMIN_EMAIL = "noornady00@gmail.com";
        const ADMIN_PASS = "noornady2007";
        const ADMIN_PHONE = "01000000000"; 
        const PHONE_DOMAIN = "@nournady.platform";

        const dictionary = {
            ar: {
                welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸã Ÿäÿß...",
                subtitle: "ŸÖŸÜÿµÿ© ŸÑÿ∑ŸÑÿßÿ® ŸÉŸÑŸäÿ© ÿßŸÑÿ™ÿ±ÿ®Ÿäÿ© - ŸÇÿ≥ŸÖ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™",
                student: "ÿ∑ÿßŸÑÿ®",
                admin: "ŸÖÿ¥ÿ±ŸÅ",
                login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                signup: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ",
                email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
                password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                name: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä",
                phone: "ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ",
                year: "ÿßŸÑŸÅÿ±ŸÇÿ© ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                year1: "ÿßŸÑŸÅÿ±ŸÇÿ© ÿßŸÑÿ£ŸàŸÑŸâ",
                year2: "ÿßŸÑŸÅÿ±ŸÇÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©",
                year3: "ÿßŸÑŸÅÿ±ŸÇÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©",
                year4: "ÿßŸÑŸÅÿ±ŸÇÿ© ÿßŸÑÿ±ÿßÿ®ÿπÿ©",
                confirmPass: "ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                submit: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®",
                waitApproval: "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! Ÿäÿ±ÿ¨Ÿâ ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÖŸàÿßŸÅŸÇÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅ.",
                dashboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ",
                courses: "ÿßŸÑŸÖŸàÿßÿØ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©",
                exams: "ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™",
                files: "ÿßŸÑŸÖŸÑŸÅÿßÿ™",
                requests: "ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ",
                students: "ÿßŸÑÿ∑ŸÑÿßÿ®",
                notifications: "ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™",
                aiAssistant: "ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä",
                settings: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
                logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                addCourse: "ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿ±ÿ≥",
                addExam: "ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÖÿ™ÿ≠ÿßŸÜ",
                manual: "ŸäÿØŸàŸä",
                ai: "ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä",
                approve: "ŸÖŸàÿßŸÅŸÇÿ©",
                reject: "ÿ±ŸÅÿ∂",
                delete: "ÿ≠ÿ∞ŸÅ",
                view: "ÿπÿ±ÿ∂",
                score: "ÿßŸÑÿØÿ±ÿ¨ÿ©",
                explanation: "ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±",
                correct: "ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©",
                wrong: "ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©",
                send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
                typeMsg: "ÿßŸÉÿ™ÿ® ŸÖÿ≥ÿ£ŸÑÿ™ŸÉ ÿ£Ÿà ÿ±ÿ≥ÿßŸÑÿ™ŸÉ...",
                saveApiKey: "ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠",
                enterApiKey: "ÿ£ÿØÿÆŸÑ ŸÖŸÅÿ™ÿßÿ≠ Gemini API",
                noData: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã",
                videoLink: "ÿ±ÿßÿ®ÿ∑ ŸäŸàÿ™ŸäŸàÿ®",
                desc: "ÿßŸÑŸàÿµŸÅ",
                title: "ÿßŸÑÿπŸÜŸàÿßŸÜ",
                subject: "ÿßŸÑŸÖÿßÿØÿ©",
                create: "ÿ•ŸÜÿ¥ÿßÿ°",
                questionsCount: "ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©",
                examType: "ŸÜŸàÿπ ÿßŸÑÿ≥ÿ§ÿßŸÑ",
                mcq: "ÿßÿÆÿ™ÿ± ŸÖŸÜ ŸÖÿ™ÿπÿØÿØ",
                tf: "ÿµÿ≠ ŸàÿÆÿ∑ÿ£",
                essay: "ŸÖŸÇÿßŸÑŸä",
                generating: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸàÿßŸÑÿ™ŸÅŸÉŸäÿ±...",
                examResult: "ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ",
                showAns: "ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™",
                yourAns: "ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ",
                correctAns: "ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©",
                uploadFile: "ÿ±ŸÅÿπ ŸÖŸÑŸÅ (ÿ±ÿßÿ®ÿ∑)",
                link: "ÿßŸÑÿ±ÿßÿ®ÿ∑",
                fileType: "ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ",
                drive: "ÿ¨Ÿàÿ¨ŸÑ ÿØÿ±ÿßŸäŸÅ",
                local: "ŸÖŸÜ ÿßŸÑÿ¨Ÿáÿßÿ≤",
                aboutDev: "ÿ™ŸÖ ÿ™ÿ∑ŸàŸäÿ± Ÿàÿ®ÿ±ŸÖÿ¨ÿ© ÿßŸÑŸÖŸÜÿµÿ© ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜŸàÿ± ŸÜÿßÿØŸä",
                addQuestion: "ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©",
                question: "ÿßŸÑÿ≥ÿ§ÿßŸÑ",
                options: "ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™ (ÿßŸÅÿµŸÑ ÿ®ŸÄ ŸÅÿßÿµŸÑÿ©)",
                correctAnswer: "ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©",
                notifTitle: "ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±",
                notifBody: "ŸÜÿµ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±",
                sendNotif: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±",
                noNotifs: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©",
                profilePic: "ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
                changePic: "ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©",
                newPassword: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©",
                saveChanges: "ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™",
                uploading: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ±ŸÅÿπ..."
            },
            en: {
                welcome: "Welcome to NOUR.NADY Platform",
                subtitle: "The leading platform for Faculty of Education - Math Dept",
                student: "Student",
                admin: "Admin",
                login: "Login",
                signup: "Sign Up",
                email: "Email",
                password: "Password",
                name: "Full Name",
                phone: "Phone Number",
                year: "Academic Year",
                year1: "First Year",
                year2: "Second Year",
                year3: "Third Year",
                year4: "Fourth Year",
                confirmPass: "Confirm Password",
                submit: "Submit Request",
                waitApproval: "Request sent successfully!",
                dashboard: "Dashboard",
                courses: "Courses",
                exams: "Exams",
                files: "Files",
                requests: "Requests",
                students: "Students",
                notifications: "Notifications",
                aiAssistant: "AI Assistant",
                settings: "Settings",
                logout: "Logout",
                addCourse: "Add Course",
                addExam: "Add Exam",
                manual: "Manual",
                ai: "AI Generated",
                approve: "Approve",
                reject: "Reject",
                delete: "Delete",
                view: "View",
                score: "Score",
                explanation: "Explanation",
                correct: "Correct",
                wrong: "Wrong",
                send: "Send",
                typeMsg: "Type your problem or message...",
                saveApiKey: "Save Key",
                enterApiKey: "Enter API Key",
                noData: "No data available",
                videoLink: "YouTube Link",
                desc: "Description",
                title: "Title",
                subject: "Subject",
                create: "Create",
                questionsCount: "Question Count",
                examType: "Question Type",
                mcq: "Multiple Choice",
                tf: "True/False",
                essay: "Essay",
                generating: "Thinking & Analyzing...",
                examResult: "Exam Result",
                showAns: "Show Answers",
                yourAns: "Your Answer",
                correctAns: "Correct Answer",
                uploadFile: "Upload File (Link)",
                link: "Link",
                fileType: "File Type",
                drive: "Google Drive",
                local: "Local Device",
                aboutDev: "Developed by Nour Nady",
                addQuestion: "Add Question to List",
                question: "Question",
                options: "Options (separate by comma)",
                correctAnswer: "Correct Answer",
                notifTitle: "Notification Title",
                notifBody: "Notification Body",
                sendNotif: "Send Notification",
                noNotifs: "No new notifications",
                profilePic: "Profile Picture",
                changePic: "Change Photo",
                newPassword: "New Password",
                saveChanges: "Save Changes",
                uploading: "Uploading..."
            }
        };

        const t = (key) => dictionary[currentLang][key] || key;

        const showToast = (msg, type = 'info') => {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            const toastIcon = document.getElementById('toastIcon');
            toastMsg.textContent = msg;
            toastIcon.className = type === 'success' ? 'fas fa-check-circle text-green-400' : 
                                  type === 'error' ? 'fas fa-exclamation-circle text-red-500' : 
                                  'fas fa-info-circle text-[#FFD700]';
            toast.classList.remove('hidden');
            toast.classList.add('animate-fade-in');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        const render = (html) => { document.getElementById('app').innerHTML = html; };
        const toggleTheme = () => { document.body.classList.toggle('light-mode'); };
        const toggleLang = () => { currentLang = currentLang === 'ar' ? 'en' : 'ar'; document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr'; router(); };

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('langToggle').addEventListener('click', toggleLang);

        const getAuthEmail = (phone) => {
            if(phone === ADMIN_PHONE) return ADMIN_EMAIL;
            return `${phone}${PHONE_DOMAIN}`;
        };

        window.toggleNotifMenu = async () => {
            const dropdown = document.getElementById('notifDropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden') && currentUser) {
                document.getElementById('notifBadge').classList.add('hidden');
                const q = query(collection(db, "notifications"), orderBy("date", "desc"));
                const snapshot = await getDocs(q);
                snapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (!data.readBy || !data.readBy.includes(currentUser.uid)) {
                        await updateDoc(doc(db, "notifications", docSnap.id), { readBy: arrayUnion(currentUser.uid) });
                    }
                });
            }
        };

        const startNotificationListener = () => {
            if (!currentUser) return;
            const q = query(collection(db, "notifications"), orderBy("date", "desc"));
            notifUnsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('notifList');
                const badge = document.getElementById('notifBadge');
                if(!list || !badge) return;
                let unreadCount = 0;
                let html = '';
                if (snapshot.empty) { html = `<div class="text-gray-500 text-center p-4 text-xs">${t('noNotifs')}</div>`; } 
                else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const isRead = data.readBy && data.readBy.includes(currentUser.uid);
                        if (!isRead) unreadCount++;
                        const icon = data.type === 'alert' ? 'fa-exclamation-circle text-red-500' : data.type === 'success' ? 'fa-check-circle text-green-400' : 'fa-info-circle text-blue-400';
                        html += `<div class="p-3 rounded bg-white/5 hover:bg-white/10 border-l-2 ${isRead ? 'border-gray-600' : 'border-[#FFD700]'} flex gap-3"><div class="mt-1"><i class="fas ${icon}"></i></div><div><h5 class="font-bold text-sm ${isRead ? 'text-gray-300' : 'text-white'}">${data.title}</h5><p class="text-xs text-gray-400 mt-1">${data.message}</p></div></div>`;
                    });
                }
                list.innerHTML = html;
                if (unreadCount > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            });
        };

        const sendSystemNotification = async (title, message, type = 'info') => {
            try { await addDoc(collection(db, "notifications"), { title, message, type, date: new Date().toISOString(), readBy: [] }); } catch (e) {}
        };

        const compressImage = async (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                };
            });
        };

        const views = {
            auth: () => `
                <div class="flex flex-col items-center justify-center min-h-[80vh] w-full animate-fade-in">
                    <div class="text-center mb-10 flex flex-col items-center">
                         <img src="noor2000.jpg" class="w-24 h-24 mb-4 logo-glow rounded-full shadow-[0_0_20px_#FFD700]">
                        <h1 class="text-5xl font-bold mb-4 neon-text-gold">NOUR.NADY</h1>
                        <p class="text-xl text-gray-300">${t('subtitle')}</p>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl w-full max-w-md neon-border-purple">
                        <div class="flex mb-6 border-b border-gray-700">
                            <button onclick="window.setAuthMode('login')" class="flex-1 pb-2 text-center ${authMode === 'login' ? 'text-[#FFD700] border-b-2 border-[#FFD700]' : 'text-gray-400'}">${t('login')}</button>
                            <button onclick="window.setAuthMode('signup')" class="flex-1 pb-2 text-center ${authMode === 'signup' ? 'text-[#FFD700] border-b-2 border-[#FFD700]' : 'text-gray-400'}">${t('signup')}</button>
                        </div>
                        <form id="authForm" class="flex flex-col gap-4">
                            ${authMode === 'signup' ? `
                                <input type="text" id="name" placeholder="${t('name')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                                <select id="year" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition">
                                    <option value="1">${t('year1')}</option>
                                    <option value="2">${t('year2')}</option>
                                    <option value="3">${t('year3')}</option>
                                    <option value="4">${t('year4')}</option>
                                </select>
                            ` : ''}
                            <input type="text" id="phone" placeholder="${t('phone')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                            <input type="password" id="password" placeholder="${t('password')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                            ${authMode === 'signup' ? `
                                <input type="password" id="confirmPass" placeholder="${t('confirmPass')}" class="p-3 rounded bg-black/50 border border-purple-900 focus:border-[#FFD700] outline-none text-white transition" required>
                            ` : ''}
                            <button type="submit" class="mt-4 bg-gradient-to-r from-purple-900 to-black border border-[#FFD700] text-[#FFD700] py-3 rounded font-bold hover:shadow-[0_0_15px_rgba(255,215,0,0.5)] transition uppercase tracking-wide">
                                ${authMode === 'login' ? t('login') : t('submit')}
                            </button>
                        </form>
                    </div>
                </div>
            `,
            signupSuccess: () => `
                <div class="flex flex-col items-center justify-center min-h-[80vh] w-full animate-fade-in">
                    <div class="glass-panel p-8 rounded-2xl w-full max-w-md neon-border-gold text-center">
                        <div class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500 shadow-[0_0_15px_rgba(0,255,0,0.3)]">
                            <i class="fas fa-check text-4xl text-green-500"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-[#FFD700] mb-4">ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠</h3>
                        <p class="text-white text-lg mb-2">ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßŸÑÿ¢ŸÜ ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</p>
                        <button onclick="window.resetToLogin()" class="bg-gradient-to-r from-purple-900 to-black border border-[#FFD700] text-[#FFD700] px-8 py-3 rounded font-bold hover:shadow-[0_0_15px_rgba(255,215,0,0.5)] transition">ÿßŸÑÿπŸàÿØÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
                    </div>
                </div>
            `,
            settings: () => `
                <div class="glass-panel p-8 rounded-xl max-w-2xl mx-auto neon-border-purple animate-fade-in relative">
                    <button onclick="window.closeSettings()" class="absolute top-4 left-4 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                    <h2 class="text-2xl font-bold text-[#FFD700] mb-6 border-b border-gray-700 pb-2">${t('settings')}</h2>
                    <div class="flex flex-col items-center mb-8 relative group">
                        <img id="profilePreview" src="${userData?.avatar || 'https://ui-avatars.com/api/?name='+userData?.name}" class="w-32 h-32 rounded-full profile-glow object-cover bg-black">
                        <label for="profileUpload" class="absolute bottom-0 bg-purple-600 text-white p-2 rounded-full cursor-pointer hover:bg-purple-500 shadow-lg"><i class="fas fa-camera"></i></label>
                        <input type="file" id="profileUpload" accept="image/*" class="hidden" onchange="window.handleImageUpload(this)">
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400">${t('name')}</label>
                            <input type="text" id="settingName" value="${userData?.name}" class="w-full p-3 bg-black/50 border border-gray-600 rounded text-white focus:border-[#FFD700]">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">${t('newPassword')}</label>
                            <input type="password" id="settingPass" placeholder="********" class="w-full p-3 bg-black/50 border border-gray-600 rounded text-white focus:border-[#FFD700]">
                        </div>
                        <button onclick="window.saveSettings()" class="w-full bg-[#FFD700] text-black font-bold py-3 rounded hover:bg-yellow-400 transition">${t('saveChanges')}</button>
                    </div>
                </div>
            `,
            adminDashboard: () => `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 animate-fade-in h-full">
                    <div class="glass-panel p-4 rounded-xl md:col-span-1 h-fit neon-border-purple">
                        <div class="flex flex-col gap-2">
                            <button onclick="window.setAdminTab('requests')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'requests' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-user-clock w-6"></i> ${t('requests')}</button>
                            <button onclick="window.setAdminTab('students')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'students' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-users w-6"></i> ${t('students')}</button>
                            <button onclick="window.setAdminTab('courses')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'courses' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-book w-6"></i> ${t('courses')}</button>
                            <button onclick="window.setAdminTab('exams')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'exams' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-pen-alt w-6"></i> ${t('exams')}</button>
                            <button onclick="window.setAdminTab('files')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'files' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-file-alt w-6"></i> ${t('files')}</button>
                             <button onclick="window.setAdminTab('notifications')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'notifications' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-bell w-6"></i> ${t('notifications')}</button>
                            <button onclick="window.setAdminTab('settings')" class="p-3 text-start rounded hover:bg-white/10 ${adminTab === 'settings' ? 'bg-purple-900/50 text-[#FFD700]' : ''}"><i class="fas fa-cog w-6"></i> ${t('settings')}</button>
                            <button onclick="handleLogout()" class="p-3 text-start rounded hover:bg-red-900/30 text-red-400 mt-4 border-t border-gray-700"><i class="fas fa-sign-out-alt w-6"></i> ${t('logout')}</button>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl md:col-span-3 min-h-[600px] neon-border-gold overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-6 text-[#FFD700] border-b border-gray-700 pb-2">${t(adminTab)}</h2>
                        <div id="adminContent">Loading...</div>
                    </div>
                </div>
            `,
            studentDashboard: () => `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <img src="${userData?.avatar || 'https://ui-avatars.com/api/?name='+userData?.name}" class="w-16 h-16 rounded-full profile-glow object-cover">
                            <div>
                                <h2 class="text-2xl font-bold neon-text-gold">${t('welcome')}, ${userData?.name}</h2>
                                <p class="text-sm text-gray-400">${t('year'+userData?.year)}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="window.openAiChat()" class="glass-panel px-4 py-2 rounded text-purple-400 hover:text-white hover:bg-purple-900/50 transition border border-purple-500 neon-border-purple shadow-[0_0_10px_#8A2BE2]"><i class="fas fa-robot mr-2"></i> ${t('aiAssistant')}</button>
                             <button onclick="window.setStudentTab('settings')" class="glass-panel px-4 py-2 rounded text-[#FFD700] hover:bg-white/10"><i class="fas fa-cog"></i></button>
                            <button onclick="handleLogout()" class="glass-panel px-4 py-2 rounded text-red-400 hover:bg-red-900/20 transition"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>
                    ${studentTab === 'settings' ? views.settings() : `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-3 glass-panel p-6 rounded-xl neon-border-gold">
                                <h3 class="text-xl font-bold mb-4 text-[#FFD700]">${t('courses')}</h3>
                                <div id="studentCoursesList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                            </div>
                        </div>
                    `}
                </div>
            `,
            courseView: () => `
                <div class="animate-fade-in">
                    <button onclick="window.location.reload()" class="mb-4 text-gray-400 hover:text-white"><i class="fas fa-arrow-right rtl:rotate-180"></i> ${t('dashboard')}</button>
                    <h2 class="text-3xl font-bold neon-text-gold mb-6">${selectedCourse.name}</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                             <div class="glass-panel p-4 rounded-xl">
                                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fab fa-youtube text-red-500"></i> Lectures</h3>
                                <div id="videoList" class="space-y-4"></div>
                             </div>
                        </div>
                        <div class="space-y-6">
                             <div class="glass-panel p-4 rounded-xl neon-border-purple">
                                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fas fa-clipboard-check text-green-400"></i> ${t('exams')}</h3>
                                <div id="examList" class="space-y-2"></div>
                             </div>
                             <div class="glass-panel p-4 rounded-xl">
                                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fas fa-folder-open text-yellow-400"></i> ${t('files')}</h3>
                                <div id="fileList" class="space-y-2"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `,
            examView: () => `
                <div class="max-w-3xl mx-auto glass-panel p-8 rounded-xl neon-border-gold animate-fade-in relative">
                    <button onclick="window.exitExam()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    <h2 class="text-2xl font-bold mb-2 text-[#FFD700]">${selectedExam.title}</h2>
                    <div id="examQuestions" class="space-y-8"></div>
                    <button id="submitExamBtn" onclick="submitExam()" class="mt-8 w-full bg-[#FFD700] text-black font-bold py-3 rounded hover:bg-yellow-400 transition">${t('submit')}</button>
                    <div id="examResultPanel" class="hidden mt-8 p-4 bg-black/40 rounded border border-purple-500">
                        <h3 class="text-2xl font-bold text-center text-white mb-2">${t('examResult')}</h3>
                        <div id="scoreDisplay" class="text-4xl font-bold text-center text-[#FFD700] mb-4"></div>
                    </div>
                </div>
            `,
            aiChat: () => `
                <div class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-[#0a0a0a] w-full max-w-2xl h-[80vh] rounded-xl neon-border-purple flex flex-col relative glass-panel">
                        <button onclick="closeAiChat()" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                        <div class="p-4 border-b border-purple-900 bg-black/40 rounded-t-xl">
                            <h3 class="text-xl font-bold text-purple-400 flex items-center gap-2"><i class="fas fa-robot text-[#FFD700]"></i> NOUR.AI Assistant</h3>
                            <p class="text-xs text-gray-400">ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿ∞ŸÉŸä ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ - ŸäÿØÿπŸÖ ÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÖÿ≥ÿßÿ¶ŸÑ</p>
                        </div>
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                            <div class="flex justify-start"><div class="bg-purple-900/30 text-gray-200 p-3 rounded-lg rounded-tl-none max-w-[85%] border border-purple-500/20">
                                ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØ ŸÜŸàÿ± ÿßŸÑÿ∞ŸÉŸä ü§ñ<br>
                                ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä:<br>
                                - ÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ© ÿßŸÑŸÖÿπŸÇÿØÿ©.<br>
                                - ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖŸÅÿßŸáŸäŸÖ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©.<br>
                                - ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸàÿ± (ŸÅŸÇÿ∑ ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ©).<br>
                                ÿ™ŸÅÿ∂ŸÑ ÿ®ÿßŸÑÿ≥ÿ§ÿßŸÑ!
                            </div></div>
                        </div>
                        
                        <!-- Image Preview Area -->
                        <div id="aiImagePreview" class="hidden px-4 py-2 bg-black/30 border-t border-gray-800">
                            <div class="relative inline-block">
                                <img id="imgPreviewSrc" src="" class="h-20 rounded border border-[#FFD700]">
                                <button onclick="clearAiImage()" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-500"><i class="fas fa-times"></i></button>
                            </div>
                        </div>

                        <div class="p-4 border-t border-purple-900 bg-black/20 rounded-b-xl">
                            <div class="flex gap-2 items-center">
                                <label for="aiImgInput" class="cursor-pointer text-gray-400 hover:text-[#FFD700] transition p-2" title="ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ŸÖÿ≥ÿ£ŸÑÿ©">
                                    <i class="fas fa-image text-xl"></i>
                                </label>
                                <input type="file" id="aiImgInput" accept="image/*" class="hidden" onchange="handleAiImageSelect(this)">
                                
                                <input type="text" id="aiInput" placeholder="${t('typeMsg')}" class="flex-1 bg-black/50 border border-gray-700 rounded p-3 text-white outline-none focus:border-[#FFD700] transition" onkeypress="if(event.key==='Enter') sendAiMessage()">
                                
                                <button onclick="sendAiMessage()" class="p-3 bg-gradient-to-r from-purple-600 to-purple-800 rounded text-white hover:from-purple-500 hover:to-purple-700 transition shadow-[0_0_10px_#8A2BE2]"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        let authMode = 'login';
        let adminTab = 'requests';
        let studentTab = 'home';
        let selectedCourse = null;
        let selectedExam = null;
        let showAiChat = false;

        window.setAuthMode = (mode) => { authMode = mode; router(); };
        window.setAdminTab = (tab) => { adminTab = tab; router(); loadAdminData(); };
        window.setStudentTab = (tab) => { studentTab = tab; router(); if(tab==='home') renderStudentCourses(); };
        window.openAiChat = () => { showAiChat = true; router(); };
        window.closeAiChat = () => { showAiChat = false; router(); };
        window.exitExam = () => { selectedExam = null; router(); };
        window.resetToLogin = () => { showSignupSuccess = false; window.setAuthMode('login'); };
        window.closeSettings = () => { if(currentUser.role === 'admin') window.setAdminTab('requests'); else window.setStudentTab('home'); };

        const handleAuth = async (e) => {
            e.preventDefault();
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const email = getAuthEmail(phone); 

            try {
                if(authMode === 'login') {
                    if((phone === ADMIN_PHONE || phone === ADMIN_EMAIL) && password === ADMIN_PASS) {
                        userData = { name: "NOUR NADY", avatar: "IMG_1068.PNG.jpg", role: 'admin' };
                        currentUser = { email: ADMIN_EMAIL, role: 'admin', uid: 'admin_001', name: "NOUR NADY" };
                        
                        try {
                            const docSnap = await getDoc(doc(db, "users", 'admin_001'));
                            if (docSnap.exists()) {
                                userData = docSnap.data();
                            }
                        } catch (e) {
                            console.log("Admin offline/mock login");
                        }
                        
                        router(); return;
                    }
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        if(data.status === 'pending') { await signOut(auth); showToast(t('waitApproval'), 'error'); }
                        else if (data.status === 'rejected') { await signOut(auth); showToast("ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ≠ÿ≥ÿßÿ®", 'error'); }
                        else { userData = data; currentUser = user; router(); }
                    }
                } else {
                    if(document.getElementById('password').value !== document.getElementById('confirmPass').value) { showToast("ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©", 'error'); return; }
                    isSigningUp = true;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, "users", user.uid), {
                        name: document.getElementById('name').value,
                        phone: phone,
                        year: document.getElementById('year').value,
                        email: email,
                        status: 'pending',
                        role: 'student',
                        avatar: '',
                        createdAt: new Date().toISOString()
                    });
                    showSignupSuccess = true; isSigningUp = false; await signOut(auth);
                }
            } catch (error) { isSigningUp = false; showToast(error.message, 'error'); }
        };

        window.handleLogout = async () => { if (notifUnsubscribe) notifUnsubscribe(); await signOut(auth); currentUser = null; userData = null; selectedCourse = null; router(); };

        window.handleImageUpload = async (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 20 * 1024 * 1024) { showToast("ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (ÿ£ŸÇÿµŸâ ÿ≠ÿØ 20MB)", "error"); return; }
                showToast(t('uploading'), 'info');
                const base64 = await compressImage(file);
                document.getElementById('profilePreview').src = base64;
                
                if (!userData) userData = {};
                userData.avatar = base64; 
            }
        };

        window.saveSettings = async () => {
            const newName = document.getElementById('settingName').value;
            const newPass = document.getElementById('settingPass').value;
            try {
                if (!userData) userData = {}; 
                const updates = { name: newName };
                if(userData.avatar) updates.avatar = userData.avatar;
                
                await setDoc(doc(db, "users", currentUser.uid), updates, { merge: true });
                if(newPass) await updatePassword(currentUser, newPass);
                
                userData.name = newName;
                showToast("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠", "success");
                
                if(currentUser.role === 'admin') window.setAdminTab('settings');
                else window.setStudentTab('home');

            } catch(e) { showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: " + e.message, "error"); }
        };

        const loadAdminData = async () => {
            const container = document.getElementById('adminContent');
            if(!container) return;
            
            if(adminTab === 'settings') { container.innerHTML = views.settings(); return; }

            if(adminTab === 'notifications') {
                 const q = query(collection(db, "notifications"), orderBy("date", "desc"));
                 const snapshot = await getDocs(q);
                 let html = `<div class="glass-panel p-6 rounded-xl border-purple-900/50 mb-6"><div class="grid grid-cols-1 gap-4"><input type="text" id="manualNotifTitle" placeholder="${t('notifTitle')}" class="p-2 bg-black/50 border border-gray-600 rounded text-white"><input type="text" id="manualNotifBody" placeholder="${t('notifBody')}" class="p-2 bg-black/50 border border-gray-600 rounded text-white"></div><button onclick="window.sendManualNotification()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded w-full">${t('send')}</button></div><div class="space-y-2">`;
                 snapshot.forEach(doc => { html += `<div class="glass-panel p-4 rounded flex justify-between"><div><h4 class="font-bold text-[#FFD700]">${doc.data().title}</h4><p class="text-sm text-gray-400">${doc.data().message}</p></div><button onclick="window.deleteNotification('${doc.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>`; });
                 container.innerHTML = html + '</div>';
                 return;
            }
            if(adminTab === 'requests') {
                const q = query(collection(db, "users"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                let html = snap.empty ? `<p class="text-gray-500">${t('noData')}</p>` : '<div class="space-y-4">';
                snap.forEach(doc => { html += `<div class="glass-panel p-4 rounded flex justify-between items-center"><div><h4 class="font-bold text-[#FFD700]">${doc.data().name}</h4><p class="text-sm text-gray-400">${doc.data().phone}</p></div><div class="flex gap-2"><button onclick="updateUserStatus('${doc.id}', 'approved')" class="text-green-400 border border-green-600 px-3 rounded">ŸÇÿ®ŸàŸÑ</button><button onclick="updateUserStatus('${doc.id}', 'rejected')" class="text-red-400 border border-red-600 px-3 rounded">ÿ±ŸÅÿ∂</button></div></div>`; });
                container.innerHTML = html + '</div>';
            }
            if(adminTab === 'students') {
                 const q = query(collection(db, "users"), where("role", "==", "student"));
                 const snap = await getDocs(q);
                 let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                 snap.forEach(doc => { const d = doc.data(); html += `<div class="glass-panel p-4 rounded relative"><div class="flex items-center gap-3"><img src="${d.avatar || 'https://ui-avatars.com/api/?name='+d.name}" class="w-10 h-10 rounded-full"><div><h4 class="font-bold text-[#FFD700]">${d.name}</h4><p class="text-xs text-gray-400">${d.phone}</p></div></div><button onclick="window.deleteUser('${doc.id}')" class="absolute top-2 right-2 text-red-500 z-10 p-2 hover:bg-white/10 rounded"><i class="fas fa-trash"></i></button></div>`; });
                 container.innerHTML = html + '</div>';
            }
            if(adminTab === 'courses') {
                const snap = await getDocs(collection(db, "courses"));
                let html = `<div class="mb-4"><button onclick="window.addNewCourse()" class="bg-[#FFD700] text-black px-4 py-2 rounded font-bold">+ ${t('addCourse')}</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                snap.forEach(docSnap => { 
                    const docId = docSnap.id;
                    const data = docSnap.data();
                    html += `
                    <div class="glass-panel p-4 rounded relative group">
                        <h4 class="font-bold text-lg text-[#FFD700]">${data.name}</h4>
                        <div class="mt-4 flex flex-col gap-2">
                            <input type="text" placeholder="YouTube Link" id="vid-${docId}" class="bg-black/30 p-1 rounded text-white text-sm">
                            <input type="text" placeholder="Title" id="title-${docId}" class="bg-black/30 p-1 rounded text-white text-sm">
                            <button onclick="window.addVideoToCourse('${docId}')" class="text-xs bg-purple-600 py-1 rounded hover:bg-purple-500">Add Video</button>
                        </div>
                        
                        <div class="mt-4 space-y-2 max-h-40 overflow-y-auto border-t border-gray-700 pt-2 custom-scrollbar">
                            <p class="text-xs text-gray-500 font-bold mb-1">ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä:</p>
                            ${(data.videos || []).map(v => `
                                <div class="flex justify-between items-center text-xs bg-white/5 p-1 rounded">
                                    <span class="truncate w-32 text-gray-300"><i class="fab fa-youtube text-red-500 mr-1"></i> ${v.title}</span>
                                    <button onclick="window.deleteVideo('${docId}', '${v.id}')" class="text-red-500 hover:text-red-300"><i class="fas fa-trash"></i></button>
                                </div>
                            `).join('')}
                            ${(data.files || []).map(f => `
                                <div class="flex justify-between items-center text-xs bg-blue-900/10 p-1 rounded">
                                    <span class="truncate w-32 text-blue-300"><i class="fas fa-file-pdf mr-1"></i> ${f.name}</span>
                                    <button onclick="window.deleteFile('${docId}', '${f.id}')" class="text-red-500 hover:text-red-300"><i class="fas fa-trash"></i></button>
                                </div>
                            `).join('')}
                            ${(data.exams || []).map(e => `
                                <div class="flex justify-between items-center text-xs bg-green-900/10 p-1 rounded">
                                    <span class="truncate w-32 text-green-300"><i class="fas fa-pen-alt mr-1"></i> ${e.title}</span>
                                    <button onclick="window.deleteExam('${docId}', '${e.id}')" class="text-red-500 hover:text-red-300"><i class="fas fa-trash"></i></button>
                                </div>
                            `).join('')}
                        </div>

                        <button onclick="window.deleteCourse('${docId}')" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>`; 
                });
                container.innerHTML = html + '</div>';
            }
            if(adminTab === 'exams') {
                 currentExamQuestions = [];
                 const snap = await getDocs(collection(db, "courses"));
                 let options = ''; snap.forEach(d => options += `<option value="${d.id}">${d.data().name}</option>`);
                 
                 container.innerHTML = `
                    <div class="space-y-6">
                        <div class="glass-panel p-6 rounded-xl border-purple-900/50">
                            <h3 class="text-xl text-[#FFD700] mb-4 font-bold border-b border-gray-800 pb-2">${t('addExam')}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">${t('courses')}</label>
                                    <select id="examCourse" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">${options}</select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">${t('title')}</label>
                                    <input type="text" id="examTitle" placeholder="${t('title')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white">
                                </div>
                            </div>

                            <div class="glass-panel p-4 rounded-lg bg-white/5 space-y-4">
                                <h4 class="text-[#8A2BE2] font-bold"><i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ§ÿßŸÑ ÿ¨ÿØŸäÿØ</h4>
                                
                                <div class="grid grid-cols-1 gap-4">
                                    <select id="qType" onchange="window.renderQuestionInputs()" class="p-2 bg-black/50 border border-gray-600 rounded text-white w-full">
                                        <option value="mcq">ÿßÿÆÿ™ÿ± ŸÖŸÜ ŸÖÿ™ÿπÿØÿØ (MCQ)</option>
                                        <option value="tf">ÿµÿ≠ ŸàÿÆÿ∑ÿ£ (True/False)</option>
                                        <option value="essay">ŸÖŸÇÿßŸÑŸä (Essay)</option>
                                    </select>
                                    
                                    <input type="text" id="qText" placeholder="ÿ±ÿ£ÿ≥ ÿßŸÑÿ≥ÿ§ÿßŸÑ" class="w-full p-3 bg-black/50 border border-gray-600 rounded text-white">
                                    
                                    <div id="qInputs" class="space-y-3 p-3 bg-black/30 rounded border border-gray-700"></div>

                                    <input type="text" id="qExplain" placeholder="ÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©" class="w-full p-3 bg-black/50 border border-gray-600 rounded text-white text-sm">
                                </div>

                                <button onclick="window.addQuestionToTempList()" class="w-full py-2 bg-purple-900/50 border border-purple-500 text-purple-200 rounded hover:bg-purple-500 hover:text-white transition">
                                    ${t('addQuestion')}
                                </button>
                            </div>

                            <div class="mt-6">
                                <h4 class="text-sm text-gray-400 mb-2">ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ∂ÿßŸÅÿ© (<span id="qTempCount">0</span>)</h4>
                                <div id="tempQuestionsList" class="space-y-2 max-h-40 overflow-y-auto mb-4"></div>
                                <button onclick="window.createExam()" class="w-full bg-[#FFD700] text-black font-bold py-3 rounded hover:shadow-[0_0_15px_rgba(255,215,0,0.4)] transition">
                                    ${t('create')}
                                </button>
                            </div>
                        </div>
                    </div>
                 `;
                 setTimeout(window.renderQuestionInputs, 100); 
            }
            if(adminTab === 'files') {
                 const snap = await getDocs(collection(db, "courses"));
                 let options = ''; snap.forEach(d => options += `<option value="${d.id}">${d.data().name}</option>`);
                 container.innerHTML = `<div class="glass-panel p-6 rounded"><select id="fileCourse" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white mb-4">${options}</select><input type="text" id="fileName" placeholder="${t('title')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white mb-4"><input type="url" id="fileUrl" placeholder="${t('link')}" class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white mb-4"><button onclick="window.addFileToCourse()" class="bg-green-600 text-white px-4 py-2 rounded w-full">${t('create')}</button></div>`;
            }
        };

        window.renderQuestionInputs = () => {
            const type = document.getElementById('qType').value;
            const container = document.getElementById('qInputs');
            
            if (type === 'mcq') {
                container.innerHTML = `
                    <p class="text-xs text-gray-400 mb-2">ÿßŸÉÿ™ÿ® ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™ ŸàÿßÿÆÿ™ÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex gap-2 items-center"><input type="radio" name="mcqCorrect" value="0" class="accent-green-500"><input type="text" id="opt0" placeholder="ÿßÿÆÿ™Ÿäÿßÿ± 1" class="flex-1 bg-black/50 p-2 rounded border border-gray-600 text-white"></div>
                        <div class="flex gap-2 items-center"><input type="radio" name="mcqCorrect" value="1" class="accent-green-500"><input type="text" id="opt1" placeholder="ÿßÿÆÿ™Ÿäÿßÿ± 2" class="flex-1 bg-black/50 p-2 rounded border border-gray-600 text-white"></div>
                        <div class="flex gap-2 items-center"><input type="radio" name="mcqCorrect" value="2" class="accent-green-500"><input type="text" id="opt2" placeholder="ÿßÿÆÿ™Ÿäÿßÿ± 3" class="flex-1 bg-black/50 p-2 rounded border border-gray-600 text-white"></div>
                        <div class="flex gap-2 items-center"><input type="radio" name="mcqCorrect" value="3" class="accent-green-500"><input type="text" id="opt3" placeholder="ÿßÿÆÿ™Ÿäÿßÿ± 4" class="flex-1 bg-black/50 p-2 rounded border border-gray-600 text-white"></div>
                    </div>
                `;
            } else if (type === 'tf') {
                container.innerHTML = `
                    <p class="text-xs text-gray-400 mb-2">ÿßÿÆÿ™ÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©:</p>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-white/5 p-2 rounded w-full"><input type="radio" name="tfCorrect" value="True" class="accent-green-500"> <span class="text-white">ÿµÿ≠ (True)</span></label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white/5 p-2 rounded w-full"><input type="radio" name="tfCorrect" value="False" class="accent-red-500"> <span class="text-white">ÿÆÿ∑ÿ£ (False)</span></label>
                    </div>
                `;
            } else if (type === 'essay') {
                container.innerHTML = `
                    <p class="text-xs text-gray-400 mb-2">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ© (ÿ≥ÿ™ÿ∏Ÿáÿ± ŸÑŸÑÿ∑ÿßŸÑÿ® ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÑ):</p>
                    <textarea id="essayModel" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ© ŸáŸÜÿß..." class="w-full p-2 bg-black/50 border border-gray-600 rounded text-white h-24"></textarea>
                `;
            }
        };

        window.addQuestionToTempList = () => {
            const q = document.getElementById('qText').value;
            const type = document.getElementById('qType').value;
            const explain = document.getElementById('qExplain').value;
            let questionObj = { q, type, explain, id: Date.now() };

            if(!q) { showToast("ÿßŸÉÿ™ÿ® ÿ±ÿ£ÿ≥ ÿßŸÑÿ≥ÿ§ÿßŸÑ", "error"); return; }

            if (type === 'mcq') {
                const opts = [
                    document.getElementById('opt0').value,
                    document.getElementById('opt1').value,
                    document.getElementById('opt2').value,
                    document.getElementById('opt3').value
                ];
                const correctIdx = document.querySelector('input[name="mcqCorrect"]:checked')?.value;
                if(opts.some(o => !o) || !correctIdx) { showToast("ÿ£ŸÉŸÖŸÑ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™ ŸàÿßÿÆÿ™ÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠", "error"); return; }
                questionObj.options = opts;
                questionObj.answer = opts[correctIdx];
            } else if (type === 'tf') {
                const correct = document.querySelector('input[name="tfCorrect"]:checked')?.value;
                if(!correct) { showToast("ÿßÿÆÿ™ÿ± ÿµÿ≠ ÿ£ŸÖ ÿÆÿ∑ÿ£", "error"); return; }
                questionObj.options = ['True', 'False'];
                questionObj.answer = correct;
            } else {
                const model = document.getElementById('essayModel').value;
                if(!model) { showToast("ÿßŸÉÿ™ÿ® ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©", "error"); return; }
                questionObj.answer = model; 
            }

            currentExamQuestions.push(questionObj);
            document.getElementById('qTempCount').textContent = currentExamQuestions.length;
            document.getElementById('tempQuestionsList').innerHTML += `<div class="bg-white/5 p-2 mb-1 rounded flex justify-between"><span>${q}</span><span class="text-xs bg-purple-900 px-2 rounded">${type}</span></div>`;
            
            document.getElementById('qText').value = '';
            document.getElementById('qExplain').value = '';
            window.renderQuestionInputs();
        };

        window.sendManualNotification = async () => {
            const title = document.getElementById('manualNotifTitle').value;
            const body = document.getElementById('manualNotifBody').value;
            if(!title || !body) return;
            await sendSystemNotification(title, body, 'info'); showToast("ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ", "success"); loadAdminData();
        };
        window.deleteNotification = async (id) => { await deleteDoc(doc(db, "notifications", id)); loadAdminData(); };
        window.updateUserStatus = async (uid, status) => { await updateDoc(doc(db, "users", uid), { status: status }); loadAdminData(); };
        
        window.deleteUser = async (id) => { 
            if(confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ∑ÿßŸÑÿ® ŸÜŸáÿßÿ¶ŸäÿßŸã ŸÖŸÜ ÿßŸÑŸÖŸàŸÇÿπ ŸàŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü\nŸÑŸÜ Ÿäÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ¨ÿØÿØÿßŸã.")) { 
                try {
                    await deleteDoc(doc(db, "users", id)); 
                    showToast("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ÿßŸÑÿ® Ÿàÿ•ÿ≤ÿßŸÑÿ© ÿµŸÑÿßÿ≠Ÿäÿßÿ™Ÿá", "success");
                    loadAdminData(); 
                } catch(e) {
                    console.error(e);
                    showToast("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: " + e.message, "error");
                }
            } 
        };

        window.addNewCourse = async () => { const name = prompt("Course Name:"); if(name) { await addDoc(collection(db, "courses"), { name, videos: [], files: [], exams: [] }); loadAdminData(); } };
        window.deleteCourse = async (id) => { if(confirm("ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿ±ÿ≥ÿü")) { await deleteDoc(doc(db, "courses", id)); loadAdminData(); } };
        
        window.deleteVideo = async (courseId, videoId) => {
            if(!confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÅŸäÿØŸäŸàÿü")) return;
            const ref = doc(db, "courses", courseId);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                const videos = snap.data().videos || [];
                const updated = videos.filter(v => v.id !== videoId);
                await updateDoc(ref, { videos: updated });
                showToast("ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ", "success");
                loadAdminData();
            }
        };

        window.deleteFile = async (courseId, fileId) => {
            if(!confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅÿü")) return;
            const ref = doc(db, "courses", courseId);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                const files = snap.data().files || [];
                const updated = files.filter(f => f.id !== fileId);
                await updateDoc(ref, { files: updated });
                showToast("ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ", "success");
                loadAdminData();
            }
        };

        window.deleteExam = async (courseId, examId) => {
            if(!confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿü")) return;
            const ref = doc(db, "courses", courseId);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                const exams = snap.data().exams || [];
                const updated = exams.filter(e => e.id !== examId);
                await updateDoc(ref, { exams: updated });
                showToast("ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ", "success");
                loadAdminData();
            }
        };

        window.addVideoToCourse = async (id) => {
             const link = document.getElementById(`vid-${id}`).value;
             const title = document.getElementById(`title-${id}`).value;
             if(!link) return;
             let vId = link.includes('v=') ? link.split('v=')[1].split('&')[0] : link.split('/').pop();
             await updateDoc(doc(db, "courses", id), { videos: arrayUnion({ id: Date.now().toString(), title: title||'Lesson', url: `https://www.youtube.com/embed/${vId}`, originalLink: link }) });
             await sendSystemNotification("ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ", `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿØÿ±ÿ≥: ${title}`, "info"); loadAdminData();
        };
        window.addFileToCourse = async () => {
             const id = document.getElementById('fileCourse').value;
             const name = document.getElementById('fileName').value;
             const url = document.getElementById('fileUrl').value;
             if(!url) return;
             await updateDoc(doc(db, "courses", id), { files: arrayUnion({ id: Date.now().toString(), name, url, date: new Date().toISOString() }) });
             await sendSystemNotification("ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ", `ÿ™ŸÖ ÿ±ŸÅÿπ ŸÖŸÑŸÅ: ${name}`, "success"); showToast("File Added", 'success'); loadAdminData();
        };
        window.createExam = async () => {
            const id = document.getElementById('examCourse').value;
            const title = document.getElementById('examTitle').value;
            if(!title || currentExamQuestions.length === 0) return;
            await updateDoc(doc(db, "courses", id), { exams: arrayUnion({ id: Date.now().toString(), title, questions: currentExamQuestions }) });
            await sendSystemNotification("ÿßŸÖÿ™ÿ≠ÿßŸÜ ÿ¨ÿØŸäÿØ", `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÖÿ™ÿ≠ÿßŸÜ: ${title}`, "alert"); showToast("Exam Created", "success"); loadAdminData();
        };

        const renderStudentCourses = async () => {
            const list = document.getElementById('studentCoursesList');
            if(!list) return;
            const snapshot = await getDocs(collection(db, "courses"));
            list.innerHTML = '';
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const el = document.createElement('div');
                el.className = 'glass-panel p-4 rounded hover:bg-white/5 cursor-pointer transition flex items-center justify-between group h-32';
                el.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-book text-purple-400 text-3xl"></i><span class="font-bold text-xl">${data.name}</span></div><i class="fas fa-chevron-left text-gray-500 rtl:rotate-180"></i>`;
                el.onclick = () => { selectedCourse = { id: docSnap.id, ...data }; router(); };
                list.appendChild(el);
            });
        };

        const renderCourseContent = () => {
            document.getElementById('videoList').innerHTML = (selectedCourse.videos || []).map(v => `<div class="mb-6"><iframe src="${v.url}" class="w-full aspect-video rounded-lg" allowfullscreen></iframe><h4 class="mt-2 font-bold text-[#FFD700]">${v.title}</h4></div>`).join('');
            document.getElementById('examList').innerHTML = (selectedCourse.exams || []).map((e, i) => `<div onclick="startExam(${i})" class="p-3 bg-white/5 rounded cursor-pointer hover:bg-white/10 flex justify-between"><span>${e.title}</span><i class="fas fa-play text-green-400"></i></div>`).join('');
            document.getElementById('fileList').innerHTML = (selectedCourse.files || []).map(f => `<a href="${f.url}" target="_blank" class="p-3 bg-white/5 rounded block hover:bg-white/10 flex justify-between"><span>${f.name}</span><i class="fas fa-download text-blue-400"></i></a>`).join('');
        };

        window.startExam = (index) => { selectedExam = selectedCourse.exams[index]; router(); 
            document.getElementById('examQuestions').innerHTML = selectedExam.questions.map((q, i) => 
                `<div class="bg-black/30 p-4 rounded border border-gray-700 q-block relative overflow-hidden" id="qblock-${i}">
                    <p class="font-bold mb-4 text-lg text-white">Q${i+1}: ${q.q}</p>
                    ${q.type === 'mcq' ? `<div class="space-y-2 options-container">${q.options.map(o => `
                        <label class="block p-3 bg-white/5 rounded cursor-pointer hover:bg-white/10 transition border border-transparent">
                            <input type="radio" name="q${i}" value="${o}" class="mr-2"> ${o}
                        </label>`).join('')}</div>` : 
                      q.type === 'tf' ? `<div class="flex gap-4 options-container">
                        <label class="flex-1 p-3 bg-white/5 rounded cursor-pointer hover:bg-white/10 transition text-center border border-transparent"><input type="radio" name="q${i}" value="True"> ÿµÿ≠</label>
                        <label class="flex-1 p-3 bg-white/5 rounded cursor-pointer hover:bg-white/10 transition text-center border border-transparent"><input type="radio" name="q${i}" value="False"> ÿÆÿ∑ÿ£</label></div>` :
                      `<textarea name="q${i}" class="w-full bg-white/5 p-3 rounded border border-gray-600 text-white min-h-[100px]" placeholder="ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ŸáŸÜÿß..."></textarea>`
                    }
                    <div id="res-${i}" class="hidden mt-4 p-4 bg-gray-900/80 rounded border-t border-gray-600 animate-fade-in">
                        <p class="font-bold text-[#FFD700] mb-1">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© / ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©:</p>
                        <p class="text-white mb-2 text-lg">${q.answer}</p>
                        ${q.explain ? `<p class="text-sm text-gray-400 border-t border-gray-700 pt-2"><strong class="text-purple-400">ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±:</strong> ${q.explain}</p>` : ''}
                    </div>
                </div>`
            ).join('');
        };
        
        window.submitExam = () => {
            let score = 0;
            document.querySelectorAll('.q-block').forEach((b, i) => {
                const q = selectedExam.questions[i];
                const resultDiv = document.getElementById(`res-${i}`);
                resultDiv.classList.remove('hidden'); 

                if(q.type !== 'essay') { 
                    const selected = b.querySelector('input:checked');
                    if(selected && selected.value === q.answer) {
                        score++;
                        b.classList.add('border-green-500');
                        b.classList.remove('border-gray-700');
                    } else {
                        b.classList.add('border-red-500');
                        b.classList.remove('border-gray-700');
                    }
                } else {
                    b.classList.add('border-yellow-500'); 
                }
            });
            document.getElementById('scoreDisplay').innerHTML = `
                <span class="text-[#FFD700]">${score}</span> / <span class="text-gray-400">${selectedExam.questions.filter(q=>q.type!=='essay').length}</span>
                <p class="text-sm text-gray-400 mt-2">ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ© ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖÿ±ÿßÿ¨ÿπÿ© ŸäÿØŸàŸäÿ©.</p>
            `;
            document.getElementById('examResultPanel').classList.remove('hidden');
            document.getElementById('submitExamBtn').classList.add('hidden'); 
            window.scrollTo(0,0);
        };

        // --- NEW AI LOGIC ---

        // Handle Image Select for AI
        window.handleAiImageSelect = (input) => {
             if(input.files && input.files[0]) {
                 const file = input.files[0];
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     selectedAiImage = e.target.result; // Base64 string
                     document.getElementById('imgPreviewSrc').src = selectedAiImage;
                     document.getElementById('aiImagePreview').classList.remove('hidden');
                 };
                 reader.readAsDataURL(file);
             }
        };

        window.clearAiImage = () => {
            selectedAiImage = null;
            document.getElementById('aiImgInput').value = '';
            document.getElementById('aiImagePreview').classList.add('hidden');
        };

        window.sendAiMessage = async () => {
            const input = document.getElementById('aiInput');
            const msg = input.value;
            
            // Allow sending if there's text OR an image
            if(!msg && !selectedAiImage) return;

            const chat = document.getElementById('chatMessages');
            
            // Build user message Bubble
            let userHtml = `<div class="flex justify-end flex-col items-end mb-2">`;
            if (selectedAiImage) {
                userHtml += `<img src="${selectedAiImage}" class="max-w-[150px] rounded mb-1 border border-gray-600">`;
            }
            if (msg) {
                userHtml += `<div class="bg-[#FFD700] text-black p-3 rounded-lg rounded-tr-none max-w-[80%] font-semibold">${msg}</div>`;
            }
            userHtml += `</div>`;
            chat.innerHTML += userHtml;
            
            // Clear inputs
            input.value = '';
            const tempImage = selectedAiImage; // Save for API call
            clearAiImage();
            
            chat.scrollTop = chat.scrollHeight;

            // Loading indicator
            const loadingId = 'loading-' + Date.now();
            chat.innerHTML += `<div id="${loadingId}" class="flex justify-start animate-fade-in"><div class="bg-purple-900/30 p-3 rounded-lg text-purple-300 flex items-center gap-2"><div class="loader w-4 h-4 border-2 rounded-full"></div> ${t('generating')}</div></div>`;
            chat.scrollTop = chat.scrollHeight;

            // --- KEY ADDED HERE AS REQUESTED ---
            const apiKey = "AIzaSyAxUi90G-9yDHrfYaLJSNTjgaK7QSpdl10"; 
            
            try {
                // Construct Gemini 2.5 Payload
                let contentParts = [];
                if (msg) contentParts.push({ text: msg });
                else if (tempImage) contentParts.push({ text: "ÿßÿ¥ÿ±ÿ≠ Ÿáÿ∞ÿß" }); // Default prompt if only image

                if (tempImage) {
                    // Extract base64 data (remove "data:image/jpeg;base64," prefix)
                    const base64Data = tempImage.split(',')[1];
                    const mimeType = tempImage.substring(tempImage.indexOf(':') + 1, tempImage.indexOf(';'));
                    
                    contentParts.push({
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Data
                        }
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            role: "user",
                            parts: contentParts 
                        }],
                        systemInstruction: {
                            parts: [{ text: "ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ ŸÑÿ∑ŸÑÿßÿ® ÿßŸÑÿ¨ÿßŸÖÿπÿßÿ™. ÿßÿ≥ŸÖŸÉ (ŸÖÿ≥ÿßÿπÿØ ŸÜŸàÿ±). \n- ÿ£ÿ¨ÿ® ÿØÿßÿ¶ŸÖÿßŸã ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©.\n- ÿπŸÜÿØ ÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ©ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ™ŸÜÿ≥ŸäŸÇ Markdown Ÿàÿßÿ∂ÿ≠ (ÿÆÿ∑Ÿàÿßÿ™ ŸÖÿ±ŸÇŸÖÿ©ÿå ŸÖÿπÿßÿØŸÑÿßÿ™ Ÿàÿßÿ∂ÿ≠ÿ©).\n- ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ±ŸÅÿπ ÿµŸàÿ±ÿ©ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÑŸäŸÑŸáÿß Ÿàÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸäŸáÿß ÿ£Ÿà ÿ¥ÿ±ÿ≠ ŸÖÿ≠ÿ™ŸàÿßŸáÿß.\n- ŸÉŸÜ ŸàÿØŸàÿØÿßŸã ŸàŸÖÿ¥ÿ¨ÿπÿßŸã." }]
                        }
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.error) {
                     throw new Error(data.error.message);
                }

                const text = data.candidates[0].content.parts[0].text;
                
                // Render Bot Response
                chat.innerHTML += `
                    <div class="flex justify-start animate-fade-in mb-4 w-full">
                        <div class="flex gap-2 max-w-[90%]">
                            <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0 border border-[#FFD700]"><i class="fas fa-robot text-white text-xs"></i></div>
                            <div class="bg-purple-900/20 p-4 rounded-lg rounded-tl-none border border-purple-500/30 text-white text-sm markdown-body w-full overflow-hidden">
                                ${marked.parse(text)}
                            </div>
                        </div>
                    </div>`;
                
                // Trigger MathJax to render equations
                if(window.MathJax) {
                    window.MathJax.typesetPromise();
                }

                chat.scrollTop = chat.scrollHeight;

            } catch(e) { 
                document.getElementById(loadingId)?.remove();
                chat.innerHTML += `<div class="flex justify-start"><div class="bg-red-900/30 text-red-300 p-3 rounded-lg border border-red-500/30">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.<br><span class="text-xs opacity-70">${e.message}</span></div></div>`;
            }
        };

        const router = () => {
            if (showSignupSuccess) { render(views.signupSuccess()); return; }
            if (currentUser) {
                document.getElementById('notifWrapper').classList.remove('hidden');
                
                const navProfile = document.getElementById('navProfile');
                navProfile.classList.remove('hidden');
                navProfile.innerHTML = `
                    <div class="flex items-center gap-2 bg-black/30 px-3 py-1 rounded-full border border-purple-500/30 backdrop-blur-sm">
                        <img src="${userData?.avatar || 'https://ui-avatars.com/api/?name='+(userData?.name || 'User')}" class="w-8 h-8 rounded-full border border-[#FFD700] object-cover">
                        <span class="text-sm font-bold text-white hidden md:block">${userData?.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</span>
                    </div>
                `;

                startNotificationListener();
                if (currentUser.role === 'admin') { render(views.adminDashboard()); loadAdminData(); }
                else if(selectedExam) { render(views.examView()); }
                else if (selectedCourse) { render(views.courseView()); renderCourseContent(); }
                else { render(views.studentDashboard()); renderStudentCourses(); }
                if(showAiChat) document.body.insertAdjacentHTML('beforeend', views.aiChat());
                else document.querySelector('.fixed.inset-0.z-50')?.remove();
            } else {
                document.getElementById('notifWrapper').classList.add('hidden');
                document.getElementById('navProfile').classList.add('hidden'); // Hide profile in auth screen
                if(notifUnsubscribe) notifUnsubscribe();
                render(views.auth());
                document.getElementById('authForm')?.addEventListener('submit', handleAuth);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (isSigningUp) return;
            if (user) {
                if(user.email === ADMIN_EMAIL) { 
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    userData = docSnap.exists() ? docSnap.data() : { name: "NOUR NADY", avatar: "IMG_1068.PNG.jpg" };
                    currentUser = { ...user, role: 'admin' }; 
                } else {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if(docSnap.exists() && docSnap.data().status === 'approved') { userData = docSnap.data(); currentUser = { ...user, role: 'student' }; }
                    else { await signOut(auth); currentUser = null; }
                }
            } else { currentUser = null; }
            router();
        });
    </script>
</body>
</html>
